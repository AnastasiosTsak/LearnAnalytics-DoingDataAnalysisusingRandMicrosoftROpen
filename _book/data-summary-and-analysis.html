<!DOCTYPE html>
<html >

<head>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>R Deep-dive</title>
  <meta content="text/html; charset=UTF-8" http-equiv="Content-Type">
  <meta name="description" content="This is a minimal example of using the bookdown package to write a book. The output format for this example is bookdown::gitbook.">
  <meta name="generator" content="bookdown 0.3 and GitBook 2.6.7">

  <meta property="og:title" content="R Deep-dive" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="This is a minimal example of using the bookdown package to write a book. The output format for this example is bookdown::gitbook." />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="R Deep-dive" />
  
  <meta name="twitter:description" content="This is a minimal example of using the bookdown package to write a book. The output format for this example is bookdown::gitbook." />
  

<meta name="author" content="Seth Mottaghinejad">


<meta name="date" content="2017-01-25">

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
  
<link rel="prev" href="creating-new-features.html">
<link rel="next" href="review.html">

<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />









<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>

</head>

<body>


  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="1" data-path="getting-started.html"><a href="getting-started.html"><i class="fa fa-check"></i><b>1</b> Getting started</a><ul>
<li class="chapter" data-level="1.1" data-path="getting-started.html"><a href="getting-started.html#loading-packages"><i class="fa fa-check"></i><b>1.1</b> Loading packages</a></li>
<li class="chapter" data-level="1.2" data-path="getting-started.html"><a href="getting-started.html#loading-data-into-r"><i class="fa fa-check"></i><b>1.2</b> Loading data into R</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="inspecting-the-data.html"><a href="inspecting-the-data.html"><i class="fa fa-check"></i><b>2</b> Inspecting the data</a><ul>
<li class="chapter" data-level="2.1" data-path="inspecting-the-data.html"><a href="inspecting-the-data.html#basic-queries"><i class="fa fa-check"></i><b>2.1</b> Basic queries</a></li>
<li class="chapter" data-level="2.2" data-path="inspecting-the-data.html"><a href="inspecting-the-data.html#more-on-querying-data"><i class="fa fa-check"></i><b>2.2</b> More on querying data</a><ul>
<li class="chapter" data-level="2.2.1" data-path="inspecting-the-data.html"><a href="inspecting-the-data.html#exercises"><i class="fa fa-check"></i><b>2.2.1</b> Exercises</a></li>
<li class="chapter" data-level="2.2.2" data-path="inspecting-the-data.html"><a href="inspecting-the-data.html#solutions"><i class="fa fa-check"></i><b>2.2.2</b> Solutions</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="inspecting-the-data.html"><a href="inspecting-the-data.html#basic-summaries"><i class="fa fa-check"></i><b>2.3</b> Basic summaries</a><ul>
<li class="chapter" data-level="2.3.1" data-path="inspecting-the-data.html"><a href="inspecting-the-data.html#exercises-1"><i class="fa fa-check"></i><b>2.3.1</b> Exercises</a></li>
<li class="chapter" data-level="2.3.2" data-path="inspecting-the-data.html"><a href="inspecting-the-data.html#solutions-1"><i class="fa fa-check"></i><b>2.3.2</b> Solutions</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="cleaning-the-data.html"><a href="cleaning-the-data.html"><i class="fa fa-check"></i><b>3</b> Cleaning the data</a><ul>
<li class="chapter" data-level="3.0.1" data-path="cleaning-the-data.html"><a href="cleaning-the-data.html#exercises-2"><i class="fa fa-check"></i><b>3.0.1</b> Exercises</a></li>
<li class="chapter" data-level="3.0.2" data-path="cleaning-the-data.html"><a href="cleaning-the-data.html#solutions-2"><i class="fa fa-check"></i><b>3.0.2</b> Solutions</a></li>
<li class="chapter" data-level="3.1" data-path="cleaning-the-data.html"><a href="cleaning-the-data.html#dealing-with-datetimes"><i class="fa fa-check"></i><b>3.1</b> Dealing with datetimes</a></li>
<li class="chapter" data-level="3.2" data-path="cleaning-the-data.html"><a href="cleaning-the-data.html#dealing-with-factors"><i class="fa fa-check"></i><b>3.2</b> Dealing with factors</a><ul>
<li class="chapter" data-level="3.2.1" data-path="cleaning-the-data.html"><a href="cleaning-the-data.html#exercises-3"><i class="fa fa-check"></i><b>3.2.1</b> Exercises</a></li>
<li class="chapter" data-level="3.2.2" data-path="cleaning-the-data.html"><a href="cleaning-the-data.html#solutions-3"><i class="fa fa-check"></i><b>3.2.2</b> Solutions</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="cleaning-the-data.html"><a href="cleaning-the-data.html#being-more-efficient"><i class="fa fa-check"></i><b>3.3</b> Being more efficient</a><ul>
<li class="chapter" data-level="3.3.1" data-path="cleaning-the-data.html"><a href="cleaning-the-data.html#exercises-4"><i class="fa fa-check"></i><b>3.3.1</b> Exercises</a></li>
<li class="chapter" data-level="3.3.2" data-path="cleaning-the-data.html"><a href="cleaning-the-data.html#solutions-4"><i class="fa fa-check"></i><b>3.3.2</b> Solutions</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="creating-new-features.html"><a href="creating-new-features.html"><i class="fa fa-check"></i><b>4</b> Creating new features</a><ul>
<li class="chapter" data-level="4.0.1" data-path="creating-new-features.html"><a href="creating-new-features.html#exercises-5"><i class="fa fa-check"></i><b>4.0.1</b> Exercises</a></li>
<li class="chapter" data-level="4.1" data-path="creating-new-features.html"><a href="creating-new-features.html#date-and-time-features"><i class="fa fa-check"></i><b>4.1</b> Date and time features</a></li>
<li class="chapter" data-level="4.2" data-path="creating-new-features.html"><a href="creating-new-features.html#geographical-features"><i class="fa fa-check"></i><b>4.2</b> Geographical features</a><ul>
<li class="chapter" data-level="4.2.1" data-path="creating-new-features.html"><a href="creating-new-features.html#exercises-6"><i class="fa fa-check"></i><b>4.2.1</b> Exercises</a></li>
<li class="chapter" data-level="4.2.2" data-path="creating-new-features.html"><a href="creating-new-features.html#solutions-5"><i class="fa fa-check"></i><b>4.2.2</b> Solutions</a></li>
</ul></li>
<li class="chapter" data-level="4.3" data-path="creating-new-features.html"><a href="creating-new-features.html#creating-a-function"><i class="fa fa-check"></i><b>4.3</b> Creating a function</a><ul>
<li class="chapter" data-level="4.3.1" data-path="creating-new-features.html"><a href="creating-new-features.html#exercises-7"><i class="fa fa-check"></i><b>4.3.1</b> Exercises</a></li>
<li class="chapter" data-level="4.3.2" data-path="creating-new-features.html"><a href="creating-new-features.html#solution"><i class="fa fa-check"></i><b>4.3.2</b> Solution</a></li>
<li class="chapter" data-level="4.3.3" data-path="creating-new-features.html"><a href="creating-new-features.html#exercises-8"><i class="fa fa-check"></i><b>4.3.3</b> Exercises</a></li>
<li class="chapter" data-level="4.3.4" data-path="creating-new-features.html"><a href="creating-new-features.html#solutions-6"><i class="fa fa-check"></i><b>4.3.4</b> Solutions</a></li>
</ul></li>
<li class="chapter" data-level="4.4" data-path="creating-new-features.html"><a href="creating-new-features.html#tipping-behavior"><i class="fa fa-check"></i><b>4.4</b> Tipping behavior</a><ul>
<li class="chapter" data-level="4.4.1" data-path="creating-new-features.html"><a href="creating-new-features.html#exercises-9"><i class="fa fa-check"></i><b>4.4.1</b> Exercises</a></li>
<li class="chapter" data-level="4.4.2" data-path="creating-new-features.html"><a href="creating-new-features.html#solutions-7"><i class="fa fa-check"></i><b>4.4.2</b> Solutions</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="data-summary-and-analysis.html"><a href="data-summary-and-analysis.html"><i class="fa fa-check"></i><b>5</b> Data summary and analysis</a><ul>
<li class="chapter" data-level="5.1" data-path="data-summary-and-analysis.html"><a href="data-summary-and-analysis.html#summary-functions"><i class="fa fa-check"></i><b>5.1</b> Summary functions</a><ul>
<li class="chapter" data-level="5.1.1" data-path="data-summary-and-analysis.html"><a href="data-summary-and-analysis.html#exercises-10"><i class="fa fa-check"></i><b>5.1.1</b> Exercises</a></li>
<li class="chapter" data-level="5.1.2" data-path="data-summary-and-analysis.html"><a href="data-summary-and-analysis.html#solutions-8"><i class="fa fa-check"></i><b>5.1.2</b> Solutions</a></li>
</ul></li>
<li class="chapter" data-level="5.2" data-path="data-summary-and-analysis.html"><a href="data-summary-and-analysis.html#data-summary-in-base-r"><i class="fa fa-check"></i><b>5.2</b> Data summary in <code>base</code> R</a><ul>
<li class="chapter" data-level="5.2.1" data-path="data-summary-and-analysis.html"><a href="data-summary-and-analysis.html#exercises-11"><i class="fa fa-check"></i><b>5.2.1</b> Exercises</a></li>
<li class="chapter" data-level="5.2.2" data-path="data-summary-and-analysis.html"><a href="data-summary-and-analysis.html#solutions-9"><i class="fa fa-check"></i><b>5.2.2</b> Solutions</a></li>
</ul></li>
<li class="chapter" data-level="5.3" data-path="data-summary-and-analysis.html"><a href="data-summary-and-analysis.html#writing-summary-functions"><i class="fa fa-check"></i><b>5.3</b> Writing summary functions</a><ul>
<li class="chapter" data-level="5.3.1" data-path="data-summary-and-analysis.html"><a href="data-summary-and-analysis.html#exercises-12"><i class="fa fa-check"></i><b>5.3.1</b> Exercises</a></li>
<li class="chapter" data-level="5.3.2" data-path="data-summary-and-analysis.html"><a href="data-summary-and-analysis.html#solutions-10"><i class="fa fa-check"></i><b>5.3.2</b> Solutions</a></li>
</ul></li>
<li class="chapter" data-level="5.4" data-path="data-summary-and-analysis.html"><a href="data-summary-and-analysis.html#data-summary-with-dplyr"><i class="fa fa-check"></i><b>5.4</b> Data summary with <code>dplyr</code></a><ul>
<li class="chapter" data-level="5.4.1" data-path="data-summary-and-analysis.html"><a href="data-summary-and-analysis.html#exercises-13"><i class="fa fa-check"></i><b>5.4.1</b> Exercises</a></li>
<li class="chapter" data-level="5.4.2" data-path="data-summary-and-analysis.html"><a href="data-summary-and-analysis.html#solutions-11"><i class="fa fa-check"></i><b>5.4.2</b> Solutions</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="review.html"><a href="review.html"><i class="fa fa-check"></i><b>6</b> Review</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">R Deep-dive</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="data-summary-and-analysis" class="section level1">
<h1><span class="header-section-number">5</span> Data summary and analysis</h1>
<p>Let’s recap where we are in the process:</p>
<ol style="list-style-type: decimal">
<li>load all the data (and combine them if necessary)</li>
<li>inspect the data in preparation cleaning it</li>
<li>clean the data in preparation for analysis</li>
<li>add any interesting features or columns as far as they pertain to the analysis</li>
<li><strong>find ways to analyze or summarize the data and report your findings</strong></li>
</ol>
<p>Of course in practice a workflow is not clean-cut the way we have it here, and it tends to be circular in that finding out certain quirks about the data forces us to go back and make certain changes to the data-cleaning process or add other features and so on.</p>
<p>We now have a data set that’s more or less ready for analysis. In the next section we go over ways we can summarize the data and produce plots and tables. Let’s run <code>str(nyc_taxi)</code> and <code>head(nyc_taxi)</code> again to review all the work we did so far.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">str</span>(nyc_taxi)</code></pre></div>
<pre><code>## Classes &#39;tbl_df&#39;, &#39;tbl&#39; and &#39;data.frame&#39;:    6000000 obs. of  25 variables:
##  $ pickup_datetime      : POSIXct, format: &quot;2016-06-21 21:33:52&quot; &quot;2016-06-08 09:52:19&quot; ...
##  $ dropoff_datetime     : POSIXct, format: &quot;2016-06-21 21:34:40&quot; &quot;2016-06-08 10:19:55&quot; ...
##  $ passenger_count      : int  5 1 1 5 3 1 1 2 1 1 ...
##  $ trip_distance        : num  0.4 5.2 2.1 2.23 2.72 1.3 8.94 0.87 1.6 2.43 ...
##  $ pickup_longitude     : num  -74 -74 -74 -74 -74 ...
##  $ pickup_latitude      : num  40.7 40.8 40.7 40.8 40.7 ...
##  $ rate_code_id         : Factor w/ 7 levels &quot;standard&quot;,&quot;JFK&quot;,..: 1 1 1 1 1 1 1 1 1 1 ...
##  $ dropoff_longitude    : num  -74 -74 -74 -74 -74 ...
##  $ dropoff_latitude     : num  40.7 40.8 40.7 40.8 40.7 ...
##  $ payment_type         : Factor w/ 2 levels &quot;card&quot;,&quot;cash&quot;: 1 2 1 1 1 2 1 1 2 2 ...
##  $ fare_amount          : num  3 21.5 9 8 17 7.5 30.5 5 9.5 10.5 ...
##  $ extra                : num  0.5 0 0.5 0.5 0.5 1 0 0.5 0 0.5 ...
##  $ mta_tax              : num  0.5 0.5 0.5 0.5 0.5 0.5 0.5 0.5 0.5 0.5 ...
##  $ tip_amount           : num  0.86 NA 1.5 2.79 3.66 2.5 7.37 1.7 0.5 NA ...
##  $ tolls_amount         : num  0 0 0 0 0 0 5.54 0 0 0 ...
##  $ improvement_surcharge: num  0.3 0.3 0.3 0.3 0.3 0.3 0.3 0.3 0.3 0.3 ...
##  $ total_amount         : num  5.16 22.3 11.8 12.09 21.96 ...
##  $ pickup_hour          : Factor w/ 7 levels &quot;1AM-5AM&quot;,&quot;5AM-9AM&quot;,..: 6 2 7 6 7 4 4 1 3 6 ...
##  $ pickup_dow           : Factor w/ 7 levels &quot;Sun&quot;,&quot;Mon&quot;,&quot;Tue&quot;,..: 3 4 3 1 6 3 1 6 7 4 ...
##  $ dropoff_hour         : Factor w/ 7 levels &quot;1AM-5AM&quot;,&quot;5AM-9AM&quot;,..: 6 3 7 6 7 4 4 1 4 6 ...
##  $ dropoff_dow          : Factor w/ 7 levels &quot;Sun&quot;,&quot;Mon&quot;,&quot;Tue&quot;,..: 3 4 3 1 7 3 1 6 7 4 ...
##  $ trip_duration        : int  48 1656 463 341 1493 514 1709 225 706 755 ...
##  $ pickup_nhood         : Factor w/ 28 levels &quot;West Village&quot;,..: 7 24 21 24 1 5 11 27 27 5 ...
##  $ dropoff_nhood        : Factor w/ 28 levels &quot;West Village&quot;,..: 5 27 NA 4 21 1 NA 11 24 17 ...
##  $ tip_percent          : int  22 NA 14 25 17 25 19 25 5 NA ...</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">head</span>(nyc_taxi, <span class="dv">3</span>)</code></pre></div>
<pre><code>## # A tibble: 3 × 25
##       pickup_datetime    dropoff_datetime passenger_count trip_distance pickup_longitude
##                &lt;dttm&gt;              &lt;dttm&gt;           &lt;int&gt;         &lt;dbl&gt;            &lt;dbl&gt;
## 1 2016-06-21 21:33:52 2016-06-21 21:34:40               5           0.4              -74
## 2 2016-06-08 09:52:19 2016-06-08 10:19:55               1           5.2              -74
## 3 2016-06-14 23:27:22 2016-06-14 23:35:05               1           2.1              -74
##   pickup_latitude rate_code_id dropoff_longitude dropoff_latitude payment_type
##             &lt;dbl&gt;       &lt;fctr&gt;             &lt;dbl&gt;            &lt;dbl&gt;       &lt;fctr&gt;
## 1            40.7     standard               -74             40.7         card
## 2            40.8     standard               -74             40.8         cash
## 3            40.7     standard               -74             40.7         card
##   fare_amount extra mta_tax tip_amount tolls_amount improvement_surcharge total_amount
##         &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt;      &lt;dbl&gt;        &lt;dbl&gt;                 &lt;dbl&gt;        &lt;dbl&gt;
## 1         3.0   0.5     0.5       0.86            0                   0.3         5.16
## 2        21.5   0.0     0.5         NA            0                   0.3        22.30
## 3         9.0   0.5     0.5       1.50            0                   0.3        11.80
##   pickup_hour pickup_dow dropoff_hour dropoff_dow trip_duration    pickup_nhood
##        &lt;fctr&gt;     &lt;fctr&gt;       &lt;fctr&gt;      &lt;fctr&gt;         &lt;int&gt;          &lt;fctr&gt;
## 1    6PM-10PM        Tue     6PM-10PM         Tue            48     Murray Hill
## 2     5AM-9AM        Wed     9AM-12PM         Wed          1656 Upper West Side
## 3    10PM-1AM        Tue     10PM-1AM         Tue           463 Lower East Side
##      dropoff_nhood tip_percent
##             &lt;fctr&gt;       &lt;int&gt;
## 1         Gramercy          22
## 2 Garment District          NA
## 3               NA          14</code></pre>
<p>We divide this chapter into three section:</p>
<ol style="list-style-type: decimal">
<li><strong>Overview of some important statistical summary functions:</strong> This is by no means a comprehensive glossary of statistical functions, but rather a sampling of the important ones and how to use them, how to modify them, and some common patterns among them.</li>
<li><strong>Data summary with <code>base</code> R tools:</strong> The <code>base</code> R tools for summarizing data are a bit more tedious and some have a different notation or way of passing arguments, but they are also widely used and they can be very efficient if used right.</li>
<li><strong>Data summary with <code>dplyr</code>:</strong> <code>dplyr</code> offers a consistent and popular notation for processing and summarizing data, and one worth learning on top of <code>base</code> R.</li>
</ol>
<p>To reiterate, statistical summary functions which we cover in section 1 can be used in either of the above cases, but what’s different is the way we query the data using those functions. For the latter, we will review two (mostly alternative) ways: one using <code>base</code> functions in section 2 and one using the <code>dplyr</code> library in section 3.</p>
<div id="summary-functions" class="section level2">
<h2><span class="header-section-number">5.1</span> Summary functions</h2>
<p>We already learned of one all-encompassing summary function, namely <code>summary</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">summary</span>(nyc_taxi) <span class="co"># summary of the whole data</span></code></pre></div>
<pre><code>##  pickup_datetime               dropoff_datetime              passenger_count
##  Min.   :2016-01-01 00:00:00   Min.   :1996-06-20 16:23:24   Min.   :0.00   
##  1st Qu.:2016-02-15 15:13:43   1st Qu.:2016-02-15 15:28:34   1st Qu.:1.00   
##  Median :2016-03-31 23:59:59   Median :2016-04-01 00:14:49   Median :1.00   
##  Mean   :2016-03-31 22:26:38   Mean   :2016-03-31 22:40:51   Mean   :1.66   
##  3rd Qu.:2016-05-15 21:27:04   3rd Qu.:2016-05-15 21:43:05   3rd Qu.:2.00   
##  Max.   :2016-06-30 23:59:56   Max.   :2016-07-01 22:38:46   Max.   :9.00   
##                                                                             
##  trip_distance     pickup_longitude pickup_latitude                rate_code_id    
##  Min.   :      0   Min.   :-75      Min.   :38      standard             :5839179  
##  1st Qu.:      1   1st Qu.:-74      1st Qu.:41      JFK                  : 128092  
##  Median :      2   Median :-74      Median :41      negotiated           :  18253  
##  Mean   :      4   Mean   :-74      Mean   :41      Newark               :  10939  
##  3rd Qu.:      3   3rd Qu.:-74      3rd Qu.:41      Nassau or Westchester:   2716  
##  Max.   :1674368   Max.   :-73      Max.   :41      (Other)              :     54  
##                    NA&#39;s   :85784    NA&#39;s   :85983   NA&#39;s                 :    767  
##  dropoff_longitude dropoff_latitude payment_type    fare_amount         extra    
##  Min.   :-75       Min.   :38       card:3982658   Min.   :  -450   Min.   :-36  
##  1st Qu.:-74       1st Qu.:41       cash:1986124   1st Qu.:     6   1st Qu.:  0  
##  Median :-74       Median :41       NA&#39;s:  31218   Median :    10   Median :  0  
##  Mean   :-74       Mean   :41                      Mean   :    13   Mean   :  0  
##  3rd Qu.:-74       3rd Qu.:41                      3rd Qu.:    14   3rd Qu.:  0  
##  Max.   :-73       Max.   :41                      Max.   :628545   Max.   :636  
##  NA&#39;s   :80650     NA&#39;s   :81540                                                 
##     mta_tax       tip_amount      tolls_amount improvement_surcharge  total_amount   
##  Min.   :-2.7   Min.   :-64      Min.   :-12   Min.   :-0.30         Min.   :  -451  
##  1st Qu.: 0.5   1st Qu.:  1      1st Qu.:  0   1st Qu.: 0.30         1st Qu.:     9  
##  Median : 0.5   Median :  2      Median :  0   Median : 0.30         Median :    12  
##  Mean   : 0.5   Mean   :  2      Mean   :  0   Mean   : 0.30         Mean   :    16  
##  3rd Qu.: 0.5   3rd Qu.:  3      3rd Qu.:  0   3rd Qu.: 0.30         3rd Qu.:    18  
##  Max.   :80.5   Max.   :844      Max.   :906   Max.   : 0.76         Max.   :629034  
##                 NA&#39;s   :832696                                                       
##    pickup_hour      pickup_dow     dropoff_hour     dropoff_dow  trip_duration       
##  1AM-5AM : 329006   Sun:800938   1AM-5AM : 342428   Sun:808101   Min.   :-631147949  
##  5AM-9AM : 918307   Mon:772497   5AM-9AM : 867447   Mon:772490   1st Qu.:       395  
##  9AM-12PM: 844536   Tue:834303   9AM-12PM: 838545   Tue:833377   Median :       661  
##  12PM-4PM:1163923   Wed:863102   12PM-4PM:1166009   Wed:861748   Mean   :       853  
##  4PM-6PM : 688718   Thu:900046   4PM-6PM : 666898   Thu:896975   3rd Qu.:      1076  
##  6PM-10PM:1395406   Fri:922501   6PM-10PM:1414732   Fri:920326   Max.   :  11122910  
##  10PM-1AM: 660104   Sat:906613   10PM-1AM: 703941   Sat:906983                       
##           pickup_nhood             dropoff_nhood      tip_percent    
##  Midtown        : 972293   Midtown        : 914279   Min.   :   -1   
##  Upper East Side: 815312   Upper East Side: 772333   1st Qu.:   14   
##  Upper West Side: 494749   Upper West Side: 489991   Median :   18   
##  Gramercy       : 466436   Gramercy       : 428740   Mean   :   17   
##  Chelsea        : 397915   Chelsea        : 358347   3rd Qu.:   20   
##  (Other)        :2296334   (Other)        :2252434   Max.   :45100   
##  NA&#39;s           : 556961   NA&#39;s           : 783876   NA&#39;s   :833023</code></pre>
<p>We can use <code>summary</code> to run a sanity check on the data and find ways that the data might need to be cleaned in preparation for analysis, but we are now interested in individual summaries. For example, here’s how we can find the average fare amount for the whole data.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">mean</span>(nyc_taxi$fare_amount) <span class="co"># the average of `fare_amount`</span></code></pre></div>
<pre><code>## [1] 13</code></pre>
<p>By specifying <code>trim = .10</code> we can get a 10 percent trimmed average, i.e. the average after throwing out the top and bottom 10 percent of the data:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">mean</span>(nyc_taxi$fare_amount, <span class="dt">trim =</span> .<span class="dv">10</span>) <span class="co"># trimmed mean</span></code></pre></div>
<pre><code>## [1] 10.7</code></pre>
<p>By default, the <code>mean</code> function will return NA if there is any NA in the data, but we can overwrite that with <code>na.rm = TRUE</code>. This same argument shows up in almost all the statistical functions we encounter in this section.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">mean</span>(nyc_taxi$trip_duration) <span class="co"># NAs are not ignored by default</span></code></pre></div>
<pre><code>## [1] 853</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">mean</span>(nyc_taxi$trip_duration, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>) <span class="co"># removes NAs before computing the average</span></code></pre></div>
<pre><code>## [1] 853</code></pre>
<p>We can use <code>weighted.mean</code> to find a weighted average. The weights are specified as the second argument, and if we fail to specify anything for weights, we just get a simple average.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">weighted.mean</span>(nyc_taxi$tip_percent, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>) <span class="co"># simple average</span></code></pre></div>
<pre><code>## [1] 17.4</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">weighted.mean</span>(nyc_taxi$tip_percent, nyc_taxi$trip_distance, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>) <span class="co"># weighted average</span></code></pre></div>
<pre><code>## [1] 16</code></pre>
<p>The <code>sd</code> function returns the standard deviation of the data, which is the same as returning the square root of its variance.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">sd</span>(nyc_taxi$trip_duration, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>) <span class="co"># standard deviation</span></code></pre></div>
<pre><code>## [1] 257845</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">sqrt</span>(<span class="kw">var</span>(nyc_taxi$trip_duration, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)) <span class="co"># standard deviation == square root of variance</span></code></pre></div>
<pre><code>## [1] 257845</code></pre>
<p>We can use <code>range</code> to get the minimum and maximum of the data at once, or use <code>min</code> and <code>max</code> individually.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">range</span>(nyc_taxi$trip_duration, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>) <span class="co"># minimum and maximum</span></code></pre></div>
<pre><code>## [1] -631147949   11122910</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">c</span>(<span class="kw">min</span>(nyc_taxi$trip_duration, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>), <span class="kw">max</span>(nyc_taxi$trip_duration, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>))</code></pre></div>
<pre><code>## [1] -631147949   11122910</code></pre>
<p>We can use <code>median</code> to return the median of the data.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">median</span>(nyc_taxi$trip_duration, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>) <span class="co"># median</span></code></pre></div>
<pre><code>## [1] 661</code></pre>
<p>The <code>quantile</code> function is used to get any percentile of the data, where the percentile is specified by the <code>probs</code> argument. For example, letting <code>probs = .5</code> returns the median.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">quantile</span>(nyc_taxi$trip_duration, <span class="dt">probs =</span> .<span class="dv">5</span>, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>) <span class="co"># median == 50th percentile</span></code></pre></div>
<pre><code>## 50% 
## 661</code></pre>
<p>We can specify a vector for <code>probs</code> to get multiple percentiles all at once. For example setting <code>probs = c(.25, .75)</code> returns the 25th and 75th percentiles.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">quantile</span>(nyc_taxi$trip_duration, <span class="dt">probs =</span> <span class="kw">c</span>(.<span class="dv">25</span>, .<span class="dv">75</span>), <span class="dt">na.rm =</span> <span class="ot">TRUE</span>) <span class="co"># IQR == difference b/w 75th and 25th percentiles</span></code></pre></div>
<pre><code>##  25%  75% 
##  395 1076</code></pre>
<p>The difference between the 25th and 75th percentiles is called the inter-quartile range, which we can also get using the <code>IQR</code> function.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">IQR</span>(nyc_taxi$trip_duration, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>) <span class="co"># interquartile range</span></code></pre></div>
<pre><code>## [1] 681</code></pre>
<p>Let’s look at a common bivariate summary statistic for numeric data: correlation.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">cor</span>(nyc_taxi$trip_distance, nyc_taxi$trip_duration, <span class="dt">use =</span> <span class="st">&quot;complete.obs&quot;</span>)</code></pre></div>
<pre><code>## [1] -0.00000114</code></pre>
<p>We can use <code>mothod</code> to switch from Pearson’s correlation to Spearman rank correlation.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">cor</span>(nyc_taxi$trip_distance, nyc_taxi$trip_duration, <span class="dt">use =</span> <span class="st">&quot;complete.obs&quot;</span>, <span class="dt">method =</span> <span class="st">&quot;spearman&quot;</span>)</code></pre></div>
<pre><code>## [1] 0.839</code></pre>
<p>Why does the Spearman correlation coefficient takes so much longer to compute?</p>
<p>So far we’ve examined functions for summarizing numeric data. Let’s now shift our attention to categorical data. We already saw that we can use <code>table</code> to get counts for each level of a <code>factor</code> column.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">table</span>(nyc_taxi$pickup_nhood) <span class="co"># one-way table</span></code></pre></div>
<pre><code>## 
##        West Village        East Village        Battery Park       Carnegie Hill 
##              140332              204170               55599               69672 
##            Gramercy                Soho         Murray Hill        Little Italy 
##              466436              119095              200315               50010 
##        Central Park   Greenwich Village             Midtown Morningside Heights 
##               80785              270512              972293               28971 
##              Harlem    Hamilton Heights             Tribeca   North Sutton Area 
##               30857               11817               97612               59162 
##     Upper East Side  Financial District              Inwood             Chelsea 
##              815312              126715                 619              397915 
##     Lower East Side           Chinatown  Washington Heights     Upper West Side 
##              139292               18155                7712              494749 
##             Clinton           Yorkville    Garment District         East Harlem 
##              177426               39669              349100               18737</code></pre>
<p>When we pass more than one column to <code>table</code>, we get counts for each <em>combination</em> of the factor levels. For example, with two columns we get counts for each combination of the levels of the first factor and the second factor. In other words, we get a two-way table.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">two_way &lt;-<span class="st"> </span><span class="kw">with</span>(nyc_taxi, <span class="kw">table</span>(pickup_nhood, dropoff_nhood)) <span class="co"># two-way table: an R `matrix`</span>
two_way[<span class="dv">1</span>:<span class="dv">5</span>, <span class="dv">1</span>:<span class="dv">5</span>]</code></pre></div>
<pre><code>##                dropoff_nhood
## pickup_nhood    West Village East Village Battery Park Carnegie Hill Gramercy
##   West Village          7232         6407         3059           390    10077
##   East Village          6119        17738         1326           393    27860
##   Battery Park          2865         1243         1748           141     2837
##   Carnegie Hill          296          273          229          2749     1565
##   Gramercy             11348        28705         3936          2122    57703</code></pre>
<p>What about a three-way table? A three-way table (or n-way table where n is an integer) is represented in R by an object we call an <code>array</code>. A vector is a one- dimensional array, a matrix a two-dimensional array, and a three-way table is a kind of three-dimensional array.</p>
<p>What about a three-way table? A three-way table (or n-way table where n is an integer) is represented in R by an object we call an <code>array</code>. A vector is a one- dimensional array, a matrix a two-dimensional array, and a three-way table is a kind of three-dimensional array.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">arr_3d &lt;-<span class="st"> </span><span class="kw">with</span>(nyc_taxi, <span class="kw">table</span>(pickup_dow, pickup_hour, payment_type)) <span class="co"># a three-way table, an R 3D `array`</span>
arr_3d</code></pre></div>
<pre><code>## , , payment_type = card
## 
##           pickup_hour
## pickup_dow 1AM-5AM 5AM-9AM 9AM-12PM 12PM-4PM 4PM-6PM 6PM-10PM 10PM-1AM
##        Sun   59674   38043    75471   107598   57482    96287    81624
##        Mon   15034   99308    68270    96841   65379   127675    36726
##        Tue   14154  112848    76431   101237   67327   148627    42899
##        Wed   15746  115180    78929   102631   66920   157233    51433
##        Thu   18162  117213    79782   105169   68080   164574    61737
##        Fri   29268  108982    77712   103210   66854   147828    78734
##        Sat   54275   48882    78994   107592   61241   128233    99129
## 
## , , payment_type = cash
## 
##           pickup_hour
## pickup_dow 1AM-5AM 5AM-9AM 9AM-12PM 12PM-4PM 4PM-6PM 6PM-10PM 10PM-1AM
##        Sun   29582   25358    44865    62249   31543    49461    37121
##        Mon   11241   41358    40619    60618   32191    52800    20505
##        Tue    9660   44922    42607    60235   32168    56569    20685
##        Wed   10938   44174    43161    59477   31537    59092    22412
##        Thu   12172   44692    43035    60186   32546    62329    25920
##        Fri   18567   43319    43707    62022   34143    68639    34471
##        Sat   26939   30345    47302    68499   37802    69633    42708</code></pre>
<p>Let’s see how we query a 3-dimensional <code>array</code>: Because we have a 3-dimensional array, we need to index it across three different dimensions:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">arr_3d[<span class="dv">3</span>, <span class="dv">2</span>, <span class="dv">2</span>] <span class="co"># give me the 3rd row, 2nd column, 2nd &#39;page&#39;</span></code></pre></div>
<pre><code>## [1] 44922</code></pre>
<p>Just as with a <code>data.frame</code>, leaving out the index for one of the dimensions returns all the values for that dimension.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">arr_3d[ , , <span class="dv">2</span>]</code></pre></div>
<pre><code>##           pickup_hour
## pickup_dow 1AM-5AM 5AM-9AM 9AM-12PM 12PM-4PM 4PM-6PM 6PM-10PM 10PM-1AM
##        Sun   29582   25358    44865    62249   31543    49461    37121
##        Mon   11241   41358    40619    60618   32191    52800    20505
##        Tue    9660   44922    42607    60235   32168    56569    20685
##        Wed   10938   44174    43161    59477   31537    59092    22412
##        Thu   12172   44692    43035    60186   32546    62329    25920
##        Fri   18567   43319    43707    62022   34143    68639    34471
##        Sat   26939   30345    47302    68499   37802    69633    42708</code></pre>
<p>We can use the names of the dimensions instead of their numeric index:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">arr_3d[<span class="st">&#39;Tue&#39;</span>, <span class="st">&#39;5AM-9AM&#39;</span>, <span class="st">&#39;cash&#39;</span>]</code></pre></div>
<pre><code>## [1] 44922</code></pre>
<p>We can turn the <code>array</code> representation into a <code>data.frame</code> representation:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">df_arr_3d &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(arr_3d) <span class="co"># same information, formatted as data frame</span>
<span class="kw">head</span>(df_arr_3d)</code></pre></div>
<pre><code>##   pickup_dow pickup_hour payment_type  Freq
## 1        Sun     1AM-5AM         card 59674
## 2        Mon     1AM-5AM         card 15034
## 3        Tue     1AM-5AM         card 14154
## 4        Wed     1AM-5AM         card 15746
## 5        Thu     1AM-5AM         card 18162
## 6        Fri     1AM-5AM         card 29268</code></pre>
<p>We can subset the <code>data.frame</code> using the <code>subset</code> function:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">subset</span>(df_arr_3d, pickup_dow ==<span class="st"> &#39;Tue&#39;</span> &amp;<span class="st"> </span>pickup_hour ==<span class="st"> &#39;5AM-9AM&#39;</span> &amp;<span class="st"> </span>payment_type ==<span class="st"> &#39;cash&#39;</span>)</code></pre></div>
<pre><code>##    pickup_dow pickup_hour payment_type  Freq
## 59        Tue     5AM-9AM         cash 44922</code></pre>
<p>Notice how the <code>array</code> notation is more terse, but not as readable (because we need to remember the order of the dimensions).</p>
<p>We can use <code>apply</code> to get aggregates of a multidimensional array across some dimension(s).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">dim</span>(arr_3d)</code></pre></div>
<pre><code>## [1] 7 7 2</code></pre>
<p>The second argument to <code>apply</code> is used to specify which dimension(s) we are aggregating over.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">apply</span>(arr_3d, <span class="dv">2</span>, sum) <span class="co"># because `pickup_hour` is the second dimension, we sum over `pickup_hour`</span></code></pre></div>
<pre><code>##  1AM-5AM  5AM-9AM 9AM-12PM 12PM-4PM  4PM-6PM 6PM-10PM 10PM-1AM 
##   325412   914624   840885  1157564   685213  1388980   656104</code></pre>
<p>Once again, when the dimensions have names it is better to use the names instead of the numeric index.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">apply</span>(arr_3d, <span class="st">&quot;pickup_hour&quot;</span>, sum) <span class="co"># same as above, but more readable notation</span></code></pre></div>
<pre><code>##  1AM-5AM  5AM-9AM 9AM-12PM 12PM-4PM  4PM-6PM 6PM-10PM 10PM-1AM 
##   325412   914624   840885  1157564   685213  1388980   656104</code></pre>
<p>So in the above example, we used apply to collapse a 3D <code>array</code> into a 2D <code>array</code> by summing across the values in the second dimension (the dimension representing pick-up hour).</p>
<p>We can use <code>prop.table</code> to turn the counts returned by <code>table</code> into proportions. The <code>prop.table</code> function has a second argument. When we leave it out, we get proportions for the grand total of the table.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">prop.table</span>(arr_3d) <span class="co"># as a proportion of the grand total</span></code></pre></div>
<pre><code>## , , payment_type = card
## 
##           pickup_hour
## pickup_dow 1AM-5AM 5AM-9AM 9AM-12PM 12PM-4PM 4PM-6PM 6PM-10PM 10PM-1AM
##        Sun 0.01000 0.00637  0.01264  0.01803 0.00963  0.01613  0.01368
##        Mon 0.00252 0.01664  0.01144  0.01622 0.01095  0.02139  0.00615
##        Tue 0.00237 0.01891  0.01281  0.01696 0.01128  0.02490  0.00719
##        Wed 0.00264 0.01930  0.01322  0.01719 0.01121  0.02634  0.00862
##        Thu 0.00304 0.01964  0.01337  0.01762 0.01141  0.02757  0.01034
##        Fri 0.00490 0.01826  0.01302  0.01729 0.01120  0.02477  0.01319
##        Sat 0.00909 0.00819  0.01323  0.01803 0.01026  0.02148  0.01661
## 
## , , payment_type = cash
## 
##           pickup_hour
## pickup_dow 1AM-5AM 5AM-9AM 9AM-12PM 12PM-4PM 4PM-6PM 6PM-10PM 10PM-1AM
##        Sun 0.00496 0.00425  0.00752  0.01043 0.00528  0.00829  0.00622
##        Mon 0.00188 0.00693  0.00681  0.01016 0.00539  0.00885  0.00344
##        Tue 0.00162 0.00753  0.00714  0.01009 0.00539  0.00948  0.00347
##        Wed 0.00183 0.00740  0.00723  0.00996 0.00528  0.00990  0.00375
##        Thu 0.00204 0.00749  0.00721  0.01008 0.00545  0.01044  0.00434
##        Fri 0.00311 0.00726  0.00732  0.01039 0.00572  0.01150  0.00578
##        Sat 0.00451 0.00508  0.00792  0.01148 0.00633  0.01167  0.00716</code></pre>
<p>For proportions out of marginal totals, we provide the second argument to <code>prop.table</code>. For example, specifying 1 as the second argument gives us proportions out of “row” totals. Recall that in a 3d object, a “row” is a 2D object, for example <code>arr_3d[1, , ]</code> is the first “row”, <code>arr3d[2, , ]</code> is the second “row” and so on.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">prop.table</span>(arr_3d, <span class="dv">1</span>) <span class="co"># as a proportion of &#39;row&#39; totals, or marginal totals for the first dimension</span></code></pre></div>
<pre><code>## , , payment_type = card
## 
##           pickup_hour
## pickup_dow 1AM-5AM 5AM-9AM 9AM-12PM 12PM-4PM 4PM-6PM 6PM-10PM 10PM-1AM
##        Sun  0.0749  0.0478   0.0948   0.1351  0.0722   0.1209   0.1025
##        Mon  0.0196  0.1292   0.0888   0.1260  0.0851   0.1661   0.0478
##        Tue  0.0170  0.1359   0.0920   0.1219  0.0811   0.1790   0.0517
##        Wed  0.0183  0.1341   0.0919   0.1195  0.0779   0.1831   0.0599
##        Thu  0.0203  0.1309   0.0891   0.1174  0.0760   0.1838   0.0689
##        Fri  0.0319  0.1188   0.0847   0.1125  0.0729   0.1611   0.0858
##        Sat  0.0602  0.0542   0.0876   0.1193  0.0679   0.1422   0.1100
## 
## , , payment_type = cash
## 
##           pickup_hour
## pickup_dow 1AM-5AM 5AM-9AM 9AM-12PM 12PM-4PM 4PM-6PM 6PM-10PM 10PM-1AM
##        Sun  0.0371  0.0318   0.0563   0.0782  0.0396   0.0621   0.0466
##        Mon  0.0146  0.0538   0.0529   0.0789  0.0419   0.0687   0.0267
##        Tue  0.0116  0.0541   0.0513   0.0725  0.0387   0.0681   0.0249
##        Wed  0.0127  0.0514   0.0503   0.0693  0.0367   0.0688   0.0261
##        Thu  0.0136  0.0499   0.0481   0.0672  0.0363   0.0696   0.0289
##        Fri  0.0202  0.0472   0.0476   0.0676  0.0372   0.0748   0.0376
##        Sat  0.0299  0.0337   0.0525   0.0760  0.0419   0.0772   0.0474</code></pre>
<p>We can confirm this by using <code>apply</code> to run the <code>sum</code> function across the first dimension to make sure that they all add up to 1.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">apply</span>(<span class="kw">prop.table</span>(arr_3d, <span class="dv">1</span>), <span class="dv">1</span>, sum) <span class="co"># check that across rows, proportions add to 1</span></code></pre></div>
<pre><code>## Sun Mon Tue Wed Thu Fri Sat 
##   1   1   1   1   1   1   1</code></pre>
<p>Similarly, if the second argument to <code>prop.table</code> is 2, we get proportions that add up to 1 across the values of the 2nd dimension. Since the second dimension corresponds to pick-up hour, for each pickup-hour, we get the proportion of observations that fall into each pick-up day of week and payment type combination.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">prop.table</span>(arr_3d, <span class="dv">2</span>) <span class="co"># as a proportion of column totals</span></code></pre></div>
<pre><code>## , , payment_type = card
## 
##           pickup_hour
## pickup_dow 1AM-5AM 5AM-9AM 9AM-12PM 12PM-4PM 4PM-6PM 6PM-10PM 10PM-1AM
##        Sun  0.1834  0.0416   0.0898   0.0930  0.0839   0.0693   0.1244
##        Mon  0.0462  0.1086   0.0812   0.0837  0.0954   0.0919   0.0560
##        Tue  0.0435  0.1234   0.0909   0.0875  0.0983   0.1070   0.0654
##        Wed  0.0484  0.1259   0.0939   0.0887  0.0977   0.1132   0.0784
##        Thu  0.0558  0.1282   0.0949   0.0909  0.0994   0.1185   0.0941
##        Fri  0.0899  0.1192   0.0924   0.0892  0.0976   0.1064   0.1200
##        Sat  0.1668  0.0534   0.0939   0.0929  0.0894   0.0923   0.1511
## 
## , , payment_type = cash
## 
##           pickup_hour
## pickup_dow 1AM-5AM 5AM-9AM 9AM-12PM 12PM-4PM 4PM-6PM 6PM-10PM 10PM-1AM
##        Sun  0.0909  0.0277   0.0534   0.0538  0.0460   0.0356   0.0566
##        Mon  0.0345  0.0452   0.0483   0.0524  0.0470   0.0380   0.0313
##        Tue  0.0297  0.0491   0.0507   0.0520  0.0469   0.0407   0.0315
##        Wed  0.0336  0.0483   0.0513   0.0514  0.0460   0.0425   0.0342
##        Thu  0.0374  0.0489   0.0512   0.0520  0.0475   0.0449   0.0395
##        Fri  0.0571  0.0474   0.0520   0.0536  0.0498   0.0494   0.0525
##        Sat  0.0828  0.0332   0.0563   0.0592  0.0552   0.0501   0.0651</code></pre>
<p>Which once again we can double-check with <code>apply</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">apply</span>(<span class="kw">prop.table</span>(arr_3d, <span class="dv">2</span>), <span class="dv">2</span>, sum) <span class="co"># check that across columns, proportions add to 1</span></code></pre></div>
<pre><code>##  1AM-5AM  5AM-9AM 9AM-12PM 12PM-4PM  4PM-6PM 6PM-10PM 10PM-1AM 
##        1        1        1        1        1        1        1</code></pre>
<p>Finally, if the second argument to <code>prop.table</code> is 3, we get proportions that add up to 1 across the values of the 3rd dimension. So for each payment type, the proportions now add up to 1.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">prop.table</span>(arr_3d, <span class="dv">3</span>) <span class="co"># as a proportion of totals across third dimension</span></code></pre></div>
<pre><code>## , , payment_type = card
## 
##           pickup_hour
## pickup_dow 1AM-5AM 5AM-9AM 9AM-12PM 12PM-4PM 4PM-6PM 6PM-10PM 10PM-1AM
##        Sun 0.01498 0.00955  0.01895  0.02702 0.01443  0.02418  0.02049
##        Mon 0.00377 0.02494  0.01714  0.02432 0.01642  0.03206  0.00922
##        Tue 0.00355 0.02833  0.01919  0.02542 0.01691  0.03732  0.01077
##        Wed 0.00395 0.02892  0.01982  0.02577 0.01680  0.03948  0.01291
##        Thu 0.00456 0.02943  0.02003  0.02641 0.01709  0.04132  0.01550
##        Fri 0.00735 0.02736  0.01951  0.02591 0.01679  0.03712  0.01977
##        Sat 0.01363 0.01227  0.01983  0.02702 0.01538  0.03220  0.02489
## 
## , , payment_type = cash
## 
##           pickup_hour
## pickup_dow 1AM-5AM 5AM-9AM 9AM-12PM 12PM-4PM 4PM-6PM 6PM-10PM 10PM-1AM
##        Sun 0.01489 0.01277  0.02259  0.03134 0.01588  0.02490  0.01869
##        Mon 0.00566 0.02082  0.02045  0.03052 0.01621  0.02658  0.01032
##        Tue 0.00486 0.02262  0.02145  0.03033 0.01620  0.02848  0.01041
##        Wed 0.00551 0.02224  0.02173  0.02995 0.01588  0.02975  0.01128
##        Thu 0.00613 0.02250  0.02167  0.03030 0.01639  0.03138  0.01305
##        Fri 0.00935 0.02181  0.02201  0.03123 0.01719  0.03456  0.01736
##        Sat 0.01356 0.01528  0.02382  0.03449 0.01903  0.03506  0.02150</code></pre>
<p>Both <code>prop.table</code> and <code>apply</code> also accepts combinations of dimensions as the second argument. This makes them powerful tools for aggregation, as long as we’re careful. For example, letting the second argument be <code>c(1, 2)</code> gives us proportions that add up to 1 for each combination of “row” and “column”. So in other words, we get the percentage of card vs cash payments for each pick-up day of week and hour combination.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">prop.table</span>(arr_3d, <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>)) <span class="co"># as a proportion of totals for each combination of 1st and 2nd dimensions</span></code></pre></div>
<pre><code>## , , payment_type = card
## 
##           pickup_hour
## pickup_dow 1AM-5AM 5AM-9AM 9AM-12PM 12PM-4PM 4PM-6PM 6PM-10PM 10PM-1AM
##        Sun   0.669   0.600    0.627    0.633   0.646    0.661    0.687
##        Mon   0.572   0.706    0.627    0.615   0.670    0.707    0.642
##        Tue   0.594   0.715    0.642    0.627   0.677    0.724    0.675
##        Wed   0.590   0.723    0.646    0.633   0.680    0.727    0.696
##        Thu   0.599   0.724    0.650    0.636   0.677    0.725    0.704
##        Fri   0.612   0.716    0.640    0.625   0.662    0.683    0.695
##        Sat   0.668   0.617    0.625    0.611   0.618    0.648    0.699
## 
## , , payment_type = cash
## 
##           pickup_hour
## pickup_dow 1AM-5AM 5AM-9AM 9AM-12PM 12PM-4PM 4PM-6PM 6PM-10PM 10PM-1AM
##        Sun   0.331   0.400    0.373    0.367   0.354    0.339    0.313
##        Mon   0.428   0.294    0.373    0.385   0.330    0.293    0.358
##        Tue   0.406   0.285    0.358    0.373   0.323    0.276    0.325
##        Wed   0.410   0.277    0.354    0.367   0.320    0.273    0.304
##        Thu   0.401   0.276    0.350    0.364   0.323    0.275    0.296
##        Fri   0.388   0.284    0.360    0.375   0.338    0.317    0.305
##        Sat   0.332   0.383    0.375    0.389   0.382    0.352    0.301</code></pre>
<div id="exercises-10" class="section level3">
<h3><span class="header-section-number">5.1.1</span> Exercises</h3>
<ol style="list-style-type: decimal">
<li>The <code>trim</code> argument for the <code>mean</code> function is two-sided. Let’s build a one- sided trimmed mean function, and one that uses counts instead of percentiles. Call it <code>mean_except_top_10</code>. For example <code>mean_except_top_10(x, 5)</code> will throw out the highest 5 values of <code>x</code> before computing the average. HINT: you can sort <code>x</code> using the <code>sort</code> function.</li>
</ol>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">mean_except_top_10</span>(<span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">5</span>, <span class="dv">3</span>, <span class="dv">99</span>), <span class="dv">1</span>) <span class="co"># should return 3</span></code></pre></div>
<hr />
<p>We just leared that the <code>probs</code> argument of <code>quantile</code> can be a vector. So instead of getting multiple quantiles separately, such as</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">c</span>(<span class="kw">quantile</span>(nyc_taxi$trip_distance, <span class="dt">probs =</span> .<span class="dv">9</span>),
  <span class="kw">quantile</span>(nyc_taxi$trip_distance, <span class="dt">probs =</span> .<span class="dv">6</span>),
  <span class="kw">quantile</span>(nyc_taxi$trip_distance, <span class="dt">probs =</span> .<span class="dv">3</span>))</code></pre></div>
<pre><code>##  90%  60%  30% 
## 6.77 2.10 1.10</code></pre>
<p>we can get them all at once by passing the percentiles we want as a single vector to <code>probs</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">quantile</span>(nyc_taxi$trip_distance, <span class="dt">probs =</span> <span class="kw">c</span>(.<span class="dv">3</span>, .<span class="dv">6</span>, .<span class="dv">9</span>))</code></pre></div>
<pre><code>##  30%  60%  90% 
## 1.10 2.10 6.77</code></pre>
<p>As it turns out, there’s a considerable difference in efficiency between the first and second approach. We explore this in this exercise:</p>
<p>There are two important tools we can use when considering efficiency:</p>
<ul>
<li><strong>profiling</strong> is a helpful tool if we need to understand what a function does under the hood (good for finding bottlenecks)</li>
<li><strong>benchmarking</strong> is the process of comparing multiple functions to see which is faster</li>
</ul>
<p>Both of these tools can be slow when working with large datasets (especially the benchmarking tool), so instead we create a vector of random numbers and use that for testing (alternatively, we could use a sample of the data). We want the vector to be big enough that test result are stable (not due to chance), but small enough that they will run within a reasonable time frame.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">random_vec &lt;-<span class="st"> </span><span class="kw">rnorm</span>(<span class="dv">10</span>^<span class="dv">6</span>) <span class="co"># a million random numbers generated from a standard normal distribution</span></code></pre></div>
<p>Let’s begin by profiling, for which we rely on the <code>profr</code> library:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(profr)
my_test_function &lt;-<span class="st"> </span>function(){
  <span class="kw">quantile</span>(random_vec, <span class="dt">p =</span> <span class="kw">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dt">by =</span> .<span class="dv">01</span>))
}
p &lt;-<span class="st"> </span><span class="kw">profr</span>(<span class="kw">my_test_function</span>())
<span class="kw">plot</span>(p)</code></pre></div>
<p><img src="images/unnamed-chunk-191-1.png" width="960" /></p>
<ol start="2" style="list-style-type: decimal">
<li>Describe what the plot is telling us: what is the bottleneck in getting quantiles?</li>
</ol>
<hr />
<p>Now onto benchmarking, we compare two functions: <code>first</code> and <code>scond</code>. <code>first</code> finds the 30th, 60th, and 90th percentiles of the data in one function call, but <code>scond</code> uses three separate function calls, one for each percentile. From the profiling tool, we now know that every time we compute percentiles, we need to sort the data, and that sorting the data is the most time-consuming part of the calculation. The benchmarking tool should show that <code>first</code> is three times more efficient than <code>scond</code>, because <code>first</code> sorts the data once and finds all three percentiles, whereas <code>scond</code> sorts the data three different times and finds one of the percentiles every time.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">first &lt;-<span class="st"> </span>function(x) <span class="kw">quantile</span>(x, <span class="dt">probs =</span> <span class="kw">c</span>(.<span class="dv">3</span>, .<span class="dv">6</span>, .<span class="dv">9</span>)) <span class="co"># get all percentiles at the same time</span>
scond &lt;-<span class="st"> </span>function(x) {
  <span class="kw">c</span>(
    <span class="kw">quantile</span>(x, <span class="dt">probs =</span> .<span class="dv">9</span>),
    <span class="kw">quantile</span>(x, <span class="dt">probs =</span> .<span class="dv">6</span>),
    <span class="kw">quantile</span>(x, <span class="dt">probs =</span> .<span class="dv">3</span>))
}

<span class="kw">library</span>(microbenchmark) <span class="co"># makes benchmarking easy</span>
<span class="kw">print</span>(<span class="kw">microbenchmark</span>(
  <span class="kw">first</span>(random_vec), <span class="co"># vectorized version</span>
  <span class="kw">scond</span>(random_vec), <span class="co"># non-vectorized</span>
  <span class="dt">times =</span> <span class="dv">10</span>))</code></pre></div>
<pre><code>## Unit: milliseconds
##               expr  min   lq mean median   uq  max neval
##  first(random_vec) 39.7 42.7 45.1   44.9 47.1 52.0    10
##  scond(random_vec) 69.4 73.0 77.9   76.5 84.0 86.5    10</code></pre>
<ol start="3" style="list-style-type: decimal">
<li>Describe what the results say? Do the runtimes bear out our intuition?</li>
</ol>
</div>
<div id="solutions-8" class="section level3">
<h3><span class="header-section-number">5.1.2</span> Solutions</h3>
<ol style="list-style-type: decimal">
<li>We can sort the vector in reverse order, throw out the top n entries and then compute the average.</li>
</ol>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">mean_except_top_10 &lt;-<span class="st"> </span>function(x, n) {
  <span class="kw">mean</span>(-<span class="kw">sort</span>(-x)[-(<span class="dv">1</span>:n)], <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)
}
<span class="kw">mean_except_top_10</span>(<span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">5</span>, <span class="dv">3</span>, <span class="dv">99</span>), <span class="dv">1</span>)</code></pre></div>
<pre><code>## [1] 3</code></pre>
<ol start="2" style="list-style-type: decimal">
<li><p>Based on the plot we can see that the almost all of the runtime of <code>my_test_function</code> is spent on sorting the vector. Sorting is a computationally intensive process and many algorithms have been devised to sort data for that reason.</p></li>
<li><p>We can look at the <code>mean</code> column to compare the average runtime of running <code>first</code> 10 times (recall that we set <code>times = 10</code>) to the average runtime for <code>scond</code>. We can see that <code>scond</code> is about twice as long.</p></li>
</ol>
</div>
</div>
<div id="data-summary-in-base-r" class="section level2">
<h2><span class="header-section-number">5.2</span> Data summary in <code>base</code> R</h2>
<p>One of the most important sets of functions in <code>base</code> R are the <code>apply</code> family of functions: we learned about <code>apply</code> earlier, and learn about <code>sapply</code>, <code>lapply</code>, and <code>tapply</code> in this section (there are more of them, but we won’t cover them all).</p>
<ul>
<li>We already learned how <code>apply</code> runs a summary function across any dimension of an <code>array</code></li>
<li><code>sapply</code> and <code>lapply</code> allow us to apply a summary function to multiple column of the data at once using them means we can type less and avoid writing loops.</li>
<li><code>tapply</code> is used to run a summary function on a column of the data, but group the result by other columns of the data</li>
</ul>
<p>Say we were interested in obtained summary statistics for all the columns listed in the vector <code>trip_metrics</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">trip_metrics &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&#39;passenger_count&#39;</span>, <span class="st">&#39;trip_distance&#39;</span>, <span class="st">&#39;fare_amount&#39;</span>, <span class="st">&#39;tip_amount&#39;</span>, <span class="st">&#39;trip_duration&#39;</span>, <span class="st">&#39;tip_percent&#39;</span>)</code></pre></div>
<p>We can use either <code>sapply</code> or <code>lapply</code> for this task. In fact, <code>sapply</code> and <code>lapply</code> have an identical syntax, but the difference is in the type output return. Let’s first look at <code>sapply</code>: <code>sapply</code> generally organizes the results in a tidy format (unsually a vector or a matrix):</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">s_res &lt;-<span class="st"> </span><span class="kw">sapply</span>(nyc_taxi[ , trip_metrics], mean)
s_res</code></pre></div>
<pre><code>## passenger_count   trip_distance     fare_amount      tip_amount   trip_duration 
##            1.66            3.81           12.98              NA          852.89 
##     tip_percent 
##              NA</code></pre>
<p>One of the great advantages of the <code>apply</code>-family of functions is that in addition to the statistical summary, we can pass any secondary argument the function takes to the function. Notice how we pass <code>na.rm = TRUE</code> to <code>sapply</code> hear so that we can remove missing values from the data before we compute the means.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">s_res &lt;-<span class="st"> </span><span class="kw">sapply</span>(nyc_taxi[ , trip_metrics], mean, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)
s_res</code></pre></div>
<pre><code>## passenger_count   trip_distance     fare_amount      tip_amount   trip_duration 
##            1.66            3.81           12.98            2.48          852.89 
##     tip_percent 
##           17.37</code></pre>
<p>The object <code>sapply</code> returns in this case is a vector: <code>mean</code> is a summary function that returns a single number, and <code>sapply</code> applies <code>mean</code> to multiple columns, returning a <strong>named vector</strong> with the means as its elements and the original column names preserved. Because <code>s_res</code> is a named vector, we can query it by name:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">s_res[<span class="st">&quot;passenger_count&quot;</span>] <span class="co"># we can query the result object by name</span></code></pre></div>
<pre><code>## passenger_count 
##            1.66</code></pre>
<p>Now let’s see what <code>lapply</code> does: unlike <code>sapply</code>, <code>lapply</code> makes no attempt to organize the results. Instead, it always returns a <code>list</code> as its output. A <code>list</code> is a very “flexible” data type, in that anything can be “dumped” into it.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">l_res &lt;-<span class="st"> </span><span class="kw">lapply</span>(nyc_taxi[ , trip_metrics], mean)
l_res</code></pre></div>
<pre><code>## $passenger_count
## [1] 1.66
## 
## $trip_distance
## [1] 3.81
## 
## $fare_amount
## [1] 13
## 
## $tip_amount
## [1] NA
## 
## $trip_duration
## [1] 853
## 
## $tip_percent
## [1] NA</code></pre>
<p>In this case, we can ‘flatten’ the <code>list</code> with the <code>unlist</code> function to get the same result as <code>sapply</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">unlist</span>(l_res) <span class="co"># this &#39;flattens&#39; the `list` and returns what `sapply` returns</span></code></pre></div>
<pre><code>## passenger_count   trip_distance     fare_amount      tip_amount   trip_duration 
##            1.66            3.81           12.98              NA          852.89 
##     tip_percent 
##              NA</code></pre>
<p>Querying a <code>list</code> is a bit more complicated. We use one bracket to query a <code>list</code>, but the return object is still a <code>list</code>, in other words, with a single bracket, we get a sublist.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">l_res[<span class="st">&quot;passenger_count&quot;</span>] <span class="co"># this is still a `list`</span></code></pre></div>
<pre><code>## $passenger_count
## [1] 1.66</code></pre>
<p>If we want to return the object itself, we use two brackets.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">l_res[[<span class="st">&quot;passenger_count&quot;</span>]] <span class="co"># this is the average count itself</span></code></pre></div>
<pre><code>## [1] 1.66</code></pre>
<p>The above distinction is not very important when all we want to do is look at the result. But when we need to perform more computations on the results we obtained, the distinction is crucial. For example, recall that both <code>s_res</code> and <code>l_res</code> store column averages for the data. Say now that we wanted to take the average for passenger count and add 1 to it, so that the count includes the driver too. With <code>s_res</code> we do the following:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">s_res[<span class="st">&quot;passenger_count&quot;</span>] &lt;-<span class="st"> </span>s_res[<span class="st">&quot;passenger_count&quot;</span>] +<span class="st"> </span><span class="dv">1</span>
s_res</code></pre></div>
<pre><code>## passenger_count   trip_distance     fare_amount      tip_amount   trip_duration 
##            2.66            3.81           12.98            2.48          852.89 
##     tip_percent 
##           17.37</code></pre>
<p>With <code>l_res</code> using a single bracket fails, because <code>l_res[&quot;passenger_count&quot;]</code> is still a <code>list</code> and we can’t add 1 to a <code>list</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">l_res[<span class="st">&quot;passenger_count&quot;</span>] &lt;-<span class="st"> </span>l_res[<span class="st">&quot;passenger_count&quot;</span>] +<span class="st"> </span><span class="dv">1</span></code></pre></div>
<pre><code>## Error in l_res[&quot;passenger_count&quot;] + 1: non-numeric argument to binary operator</code></pre>
<p>So we need to use two brackets to perform the same operation on <code>l_res</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">l_res[[<span class="st">&quot;passenger_count&quot;</span>]] &lt;-<span class="st"> </span>l_res[[<span class="st">&quot;passenger_count&quot;</span>]] +<span class="st"> </span><span class="dv">1</span>
l_res</code></pre></div>
<pre><code>## $passenger_count
## [1] 2.66
## 
## $trip_distance
## [1] 3.81
## 
## $fare_amount
## [1] 13
## 
## $tip_amount
## [1] NA
## 
## $trip_duration
## [1] 853
## 
## $tip_percent
## [1] NA</code></pre>
<p>Let’s look at our last function in the <code>apply</code> family now, namely <code>tapply</code>: We use <code>tapply</code> to apply a function to the a column, <strong>but group the results by the values other columns.</strong></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">tapply</span>(nyc_taxi$tip_amount, nyc_taxi$pickup_nhood, mean, <span class="dt">trim =</span> <span class="fl">0.1</span>, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>) <span class="co"># trimmed average tip, by pickup neighborhood</span></code></pre></div>
<pre><code>##        West Village        East Village        Battery Park       Carnegie Hill 
##                2.00                2.03                2.65                1.89 
##            Gramercy                Soho         Murray Hill        Little Italy 
##                1.91                2.07                2.02                2.06 
##        Central Park   Greenwich Village             Midtown Morningside Heights 
##                1.94                1.96                2.07                2.08 
##              Harlem    Hamilton Heights             Tribeca   North Sutton Area 
##                1.76                1.95                2.17                1.86 
##     Upper East Side  Financial District              Inwood             Chelsea 
##                1.85                2.76                2.21                1.95 
##     Lower East Side           Chinatown  Washington Heights     Upper West Side 
##                2.18                2.18                2.32                1.87 
##             Clinton           Yorkville    Garment District         East Harlem 
##                1.98                1.83                2.04                1.69</code></pre>
<p>We can group the results by pickup and dropoff neighborhood pairs, by combining those two columns into one. For example, the <code>paste</code> function concatenates the pick-up and drop-off neighborhoods into a single string. The result is a flat vector with one element for each pick-up and drop-off neighborhood combination.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">flat_array &lt;-<span class="st"> </span><span class="kw">tapply</span>(nyc_taxi$tip_amount,
<span class="kw">paste</span>(nyc_taxi$pickup_nhood, nyc_taxi$dropoff_nhood, <span class="dt">sep =</span> <span class="st">&quot; to &quot;</span>),
mean, <span class="dt">trim =</span> <span class="fl">0.1</span>, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)

<span class="kw">head</span>(flat_array)</code></pre></div>
<pre><code>##  Battery Park to Battery Park Battery Park to Carnegie Hill  Battery Park to Central Park 
##                          1.38                          5.25                          4.57 
##       Battery Park to Chelsea     Battery Park to Chinatown       Battery Park to Clinton 
##                          2.35                          1.87                          3.02</code></pre>
<p>By putting both grouping columns in a <code>list</code> we can get an <code>array</code> (a 2D <code>array</code> or <code>matrix</code> in this case) instead of the flat vector we got earlier.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">square_array &lt;-<span class="st"> </span><span class="kw">tapply</span>(nyc_taxi$tip_amount,
<span class="kw">list</span>(nyc_taxi$pickup_nhood, nyc_taxi$dropoff_nhood),
mean, <span class="dt">trim =</span> <span class="fl">0.1</span>, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)

square_array[<span class="dv">1</span>:<span class="dv">5</span>, <span class="dv">1</span>:<span class="dv">5</span>]</code></pre></div>
<pre><code>##               West Village East Village Battery Park Carnegie Hill Gramercy
## West Village          1.14         1.92         1.80          4.00     1.87
## East Village          1.85         1.20         2.63          3.41     1.50
## Battery Park          1.83         2.84         1.38          5.25     3.36
## Carnegie Hill         4.33         3.72         5.00          1.06     3.35
## Gramercy              1.83         1.57         2.94          3.01     1.29</code></pre>
<div id="exercises-11" class="section level3">
<h3><span class="header-section-number">5.2.1</span> Exercises</h3>
<p>Let’s look at two other cases of using <code>sapply</code> vs <code>lapply</code>, one involving <code>quantile</code> and one involving <code>unique</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">qsap1 &lt;-<span class="st"> </span><span class="kw">sapply</span>(nyc_taxi[ , trip_metrics], quantile, <span class="dt">probs =</span> <span class="kw">c</span>(.<span class="dv">01</span>, .<span class="dv">05</span>, .<span class="dv">95</span>, .<span class="dv">99</span>), <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)
qlap1 &lt;-<span class="st"> </span><span class="kw">lapply</span>(nyc_taxi[ , trip_metrics], quantile, <span class="dt">probs =</span> <span class="kw">c</span>(.<span class="dv">01</span>, .<span class="dv">05</span>, .<span class="dv">95</span>, .<span class="dv">99</span>), <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)</code></pre></div>
<ol style="list-style-type: decimal">
<li>Query <code>qsap1</code> and <code>qlap1</code> for the 5th and 95th percentiles of <code>trip_distance</code> and <code>trip_duration</code>.</li>
</ol>
<p>Let’s now try the same, but this time pass the <code>unique</code> function to both, which returns the unique values in the data for each of the columns.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">qsap2 &lt;-<span class="st"> </span><span class="kw">sapply</span>(nyc_taxi[ , trip_metrics], unique)
qlap2 &lt;-<span class="st"> </span><span class="kw">lapply</span>(nyc_taxi[ , trip_metrics], unique)</code></pre></div>
<ol start="2" style="list-style-type: decimal">
<li><p>Query <code>qsap2</code> and <code>qlap2</code> to show the distinct values of <code>passenger_count</code> and <code>tip_percent</code>. Can you tell why did <code>sapply</code> and <code>lapply</code> both return lists in the second case?</p></li>
<li><p>Use <code>qlap2</code> to find the number of unique values for each column.</p></li>
</ol>
</div>
<div id="solutions-9" class="section level3">
<h3><span class="header-section-number">5.2.2</span> Solutions</h3>
<ol style="list-style-type: decimal">
<li>Because <code>qsap1</code> is a matrix, we can query it the same way we query any n-dimensional <code>array</code>:</li>
</ol>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">qsap1[<span class="kw">c</span>(<span class="st">&#39;5%&#39;</span>, <span class="st">&#39;95%&#39;</span>), <span class="kw">c</span>(<span class="st">&#39;trip_distance&#39;</span>, <span class="st">&#39;trip_duration&#39;</span>)]</code></pre></div>
<pre><code>##     trip_distance trip_duration
## 5%            0.5           177
## 95%          10.5          2107</code></pre>
<p>Since <code>qlap1</code> is a list with one element per each column of the data, we use two brackets to extract the percentiles for column separately. Moreover, because the percentiles themselves are stored in a named vector, we can pass the names of the percentiles we want in a single bracket to get the desired result.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">qlap1[[<span class="st">&#39;trip_distance&#39;</span>]][<span class="kw">c</span>(<span class="st">&#39;5%&#39;</span>, <span class="st">&#39;95%&#39;</span>)]</code></pre></div>
<pre><code>##   5%  95% 
##  0.5 10.5</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">qlap1[[<span class="st">&#39;trip_duration&#39;</span>]][<span class="kw">c</span>(<span class="st">&#39;5%&#39;</span>, <span class="st">&#39;95%&#39;</span>)]</code></pre></div>
<pre><code>##   5%  95% 
##  177 2107</code></pre>
<ol start="2" style="list-style-type: decimal">
<li>In this case, <code>sapply</code> and <code>lapply</code> both return a <code>list</code>, simply because there is no other way for <code>sapply</code> to organize the results. We can just return the results for <code>passenger_count</code> and <code>tip_percent</code> as a sublist.</li>
</ol>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">qsap2[<span class="kw">c</span>(<span class="st">&#39;passenger_count&#39;</span>, <span class="st">&#39;tip_percent&#39;</span>)]</code></pre></div>
<pre><code>## $passenger_count
##  [1] 5 1 3 2 6 4 0 8 7 9
## 
## $tip_percent
##   [1]    22    NA    14    25    17    19     5    16    18    21    20    10    35     6
##  [15]    11    13     7     8     0    12    15    33    24    40    30     9    26    27
##  [29]    28    23    29    78    36     4    32    47     1    51    88     2    37    41
##  [43]    46   100    99    39    34    54     3    42    59    50    84    86    38    56
##  [57]    44    43    45    72    57    55    71    31    63    60    66    91    94    76
##  [71]   400    53    69    49    70    68    62    61    81    52    64    80   350    48
##  [85]    58    73    67    96    85    95    83    97    92    65    77    89  2100  5300
##  [99]    75    98    74    82   700    90   800    87   450   850    79   500    93 45100
## [113]   550   600   650  2150  1300  1430   900 10100  1650  3180  1380  3629    -1   750
## [127]  1150  2200  9284</code></pre>
<ol start="3" style="list-style-type: decimal">
<li>Since we have the unique values for each column stored in <code>qlap2</code>, we can just run the <code>length</code> function to count how many unique values each column has. For example, for <code>passenger_count</code> we have</li>
</ol>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">length</span>(qlap2[[<span class="st">&#39;passenger_count&#39;</span>]]) <span class="co"># don&#39;t forget the double bracket here!</span></code></pre></div>
<pre><code>## [1] 10</code></pre>
<p>But we want to do this automatically for all the columns at once. The solution is to use <code>sapply</code>. So far we’ve been using <code>sapply</code> and <code>lapply</code> with the dataset as input. But we can just as well feed them any random list like <code>qsap</code> and apply a function to each element of that list (as long as doing so doesn’t result in an error for any of the list’s elements).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">sapply</span>(qlap2, length)</code></pre></div>
<pre><code>## passenger_count   trip_distance     fare_amount      tip_amount   trip_duration 
##              10            4035            1524            3120           10806 
##     tip_percent 
##             129</code></pre>
<p>The above exercise offers a glimpse of how powerful R can be and quickly and succinctly processing the basic data types, as long as we write good functions and use the <code>apply</code> family of functions to iterate through the data types. A good goal to set for yourself as an R programmer is to increase your reliance on the <code>apply</code> family of function to run your code.</p>
</div>
</div>
<div id="writing-summary-functions" class="section level2">
<h2><span class="header-section-number">5.3</span> Writing summary functions</h2>
<p>As we use R more and more, we will see that a lot of R functions return a <code>list</code> as output (or something that is fundamentally a <code>list</code> but looks cosmetically different). In fact, as it happens a <code>data.frame</code> is also just a kind a <code>list</code>, with each element of the list corresponding to a column of the <code>data.frame</code>, and <strong>all elements having the same length</strong>. Why would a <code>data.frame</code> be a <code>list</code> and not a <code>matrix</code>? Because like a <code>vector</code>, a <code>matirx</code> or any <code>array</code> is <strong>atomic</strong>, meaning that its elements must be of the same type (usually <code>numeric</code>). Notice what happens if we try to force a vector to have one <code>character</code> element and one <code>numeric</code> one:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">c</span>(<span class="st">&quot;one&quot;</span>, <span class="dv">1</span>)</code></pre></div>
<pre><code>## [1] &quot;one&quot; &quot;1&quot;</code></pre>
<p>The second element was <strong>coerced</strong> into the string “1”. A <code>list</code> will not complain about this:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">list</span>(<span class="st">&quot;one&quot;</span>, <span class="dv">1</span>)</code></pre></div>
<pre><code>## [[1]]
## [1] &quot;one&quot;
## 
## [[2]]
## [1] 1</code></pre>
<p>Since columns of a <code>data.frame</code> can be of different types, it makes sense that under the hood a <code>data.frame</code> is really just a <code>list.</code> We can check that a <code>data.frame</code> is a kind of list <strong>under the hood</strong> by using the <code>typeof</code> function instead of <code>class</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">class</span>(nyc_taxi)</code></pre></div>
<pre><code>## [1] &quot;tbl_df&quot;     &quot;tbl&quot;        &quot;data.frame&quot;</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">typeof</span>(nyc_taxi)</code></pre></div>
<pre><code>## [1] &quot;list&quot;</code></pre>
<p>This <strong>flexibility</strong> is the reason functions that return lots of loosely-related results return them as a single list. This includes most functions that perform various statistical tests, such as the <code>lm</code> function.</p>
<p>We can also write our own summary functions and demonstrate this. In section 6.1, we focused on single summaries (such as <code>mean</code>), or multiple related ones (such as <code>quantile</code>), but now we want to write a function that combines different summaries and returns all of them at once. The trick is basically to wrap everything into a <code>list</code> and return the <code>list</code>. The function <code>my.summary</code> shown here is an example of such a function. It consists of mostly of separate but related summaries that are calculated piece-wise and then put together into a list and returned by the function.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">my.summary &lt;-<span class="st"> </span>function(grp_1, grp_2, resp) {
<span class="co"># `grp_1` and `grp_2` are `character` or `factor` columns</span>
<span class="co"># `resp` is a numeric column</span>
  mean &lt;-<span class="st"> </span><span class="kw">mean</span>(resp, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>) <span class="co"># mean</span>
  sorted_resp &lt;-<span class="st"> </span><span class="kw">sort</span>(resp)
  n &lt;-<span class="st"> </span><span class="kw">length</span>(resp)
  mean_minus_top =<span class="st"> </span><span class="kw">mean</span>(sorted_resp[<span class="dv">1</span>:(n<span class="dv">-19</span>)], <span class="dt">na.rm =</span> <span class="ot">TRUE</span>) <span class="co"># average after throwing out highest 20 values</span>
  tt_1 &lt;-<span class="st"> </span><span class="kw">table</span>(grp_1, grp_2) <span class="co"># the total count</span>
  ptt_1 &lt;-<span class="st"> </span><span class="kw">prop.table</span>(tt_1, <span class="dv">1</span>) <span class="co"># proportions for each level of the response</span>
  ptt_2 &lt;-<span class="st"> </span><span class="kw">prop.table</span>(tt_1, <span class="dv">2</span>) <span class="co"># proportions for each level of the response</span>
  tt_2 &lt;-<span class="st"> </span><span class="kw">tapply</span>(resp, <span class="kw">list</span>(grp_1, grp_2), mean, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)
<span class="co"># return everything as a list:</span>
  <span class="kw">list</span>(<span class="dt">mean =</span> mean,
  <span class="dt">trimmed_mean =</span> mean_minus_top,
  <span class="dt">row_proportions =</span> ptt_1,
  <span class="dt">col_proportions =</span> ptt_2,
  <span class="dt">average_by_group =</span> tt_2
  )
}

<span class="kw">my.summary</span>(nyc_taxi$pickup_dow, nyc_taxi$pickup_hour, nyc_taxi$tip_amount) <span class="co"># test the function</span></code></pre></div>
<pre><code>## $mean
## [1] 2.48
## 
## $trimmed_mean
## [1] 2.48
## 
## $row_proportions
##      grp_2
## grp_1 1AM-5AM 5AM-9AM 9AM-12PM 12PM-4PM 4PM-6PM 6PM-10PM 10PM-1AM
##   Sun  0.1126  0.0796   0.1509   0.2131  0.1117   0.1830   0.1491
##   Mon  0.0344  0.1828   0.1416   0.2049  0.1269   0.2347   0.0746
##   Tue  0.0289  0.1898   0.1433   0.1946  0.1199   0.2470   0.0767
##   Wed  0.0313  0.1853   0.1421   0.1889  0.1146   0.2517   0.0861
##   Thu  0.0341  0.1805   0.1370   0.1847  0.1123   0.2532   0.0980
##   Fri  0.0525  0.1658   0.1322   0.1802  0.1101   0.2358   0.1234
##   Sat  0.0905  0.0879   0.1398   0.1953  0.1098   0.2193   0.1574
## 
## $col_proportions
##      grp_2
## grp_1 1AM-5AM 5AM-9AM 9AM-12PM 12PM-4PM 4PM-6PM 6PM-10PM 10PM-1AM
##   Sun  0.2740  0.0694   0.1431   0.1467  0.1299   0.1050   0.1810
##   Mon  0.0808  0.1538   0.1295   0.1360  0.1424   0.1299   0.0873
##   Tue  0.0732  0.1724   0.1416   0.1395  0.1452   0.1477   0.0969
##   Wed  0.0820  0.1742   0.1452   0.1400  0.1437   0.1557   0.1126
##   Thu  0.0933  0.1769   0.1461   0.1429  0.1468   0.1633   0.1336
##   Fri  0.1471  0.1665   0.1444   0.1428  0.1475   0.1559   0.1725
##   Sat  0.2495  0.0867   0.1501   0.1521  0.1446   0.1425   0.2161
## 
## $average_by_group
##     1AM-5AM 5AM-9AM 9AM-12PM 12PM-4PM 4PM-6PM 6PM-10PM 10PM-1AM
## Sun    2.33    2.42     2.22     2.49    2.49     2.53     2.41
## Mon    2.93    2.42     2.51     2.56    2.47     2.51     2.72
## Tue    2.71    2.33     2.53     2.60    2.51     2.52     2.69
## Wed    2.75    2.34     2.54     2.73    2.61     2.52     2.62
## Thu    2.76    2.36     2.55     2.76    2.62     2.55     2.63
## Fri    2.71    2.36     2.47     2.65    2.53     2.42     2.54
## Sat    2.40    2.36     2.15     2.28    2.26     2.26     2.40</code></pre>
<p>Looking at the above result, we can see that something went wrong with the trimmed mean: the trimmed mean and the mean appear to be the same, which is very unlikely. It’s not obvious what the bug is. Take a moment and try find out what the problem is and propose a fix.</p>
<p>One thing that makes it hard to debug the function is that we do not have direct access to its <strong>environment</strong>. We need a way to “step inside” the function and run it line by line so we can see where the problem is. This is what <code>debug</code> is for.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">debug</span>(my.summary) <span class="co"># puts the function in debug mode</span></code></pre></div>
<p>Now, anytime we run the function we leave our current “global” environment and step into the function’s environment, where we have access to all the local variables in the function as we run the code line-by-line.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">my.summary</span>(nyc_taxi$pickup_dow, nyc_taxi$pickup_hour, nyc_taxi$tip_amount)</code></pre></div>
<p>We start at the beginning, where the only things evaluated are the function’s arguments. We can press ENTER to run the next line. After running each line, we can query the object to see if it looks like it should. We can always go back to the global environment by pressing Q and ENTER. If you were unsuccessful at fixing the bug earlier, take a second stab at it now. (HINT: it has something to do with NAs.)</p>
<p>Once we resolve the issue, we run <code>undebug</code> so the function can now run normally.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">undebug</span>(my.summary)</code></pre></div>
<p>To run <code>my.summary</code> on multiple numeric columns at once, we can use <code>lapply</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">res &lt;-<span class="st"> </span><span class="kw">lapply</span>(nyc_taxi[ , trip_metrics], my.summary, <span class="dt">grp_1 =</span> nyc_taxi$pickup_dow, <span class="dt">grp_2 =</span> nyc_taxi$pickup_hour)</code></pre></div>
<p><code>res</code> is just a nested <code>list</code> and we can ‘drill into’ any individual piece we want with the right query. At the first level are the column names.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">res$tip_amount</code></pre></div>
<pre><code>## $mean
## [1] 2.48
## 
## $trimmed_mean
## [1] 2.48
## 
## $row_proportions
##      grp_2
## grp_1 1AM-5AM 5AM-9AM 9AM-12PM 12PM-4PM 4PM-6PM 6PM-10PM 10PM-1AM
##   Sun  0.1126  0.0796   0.1509   0.2131  0.1117   0.1830   0.1491
##   Mon  0.0344  0.1828   0.1416   0.2049  0.1269   0.2347   0.0746
##   Tue  0.0289  0.1898   0.1433   0.1946  0.1199   0.2470   0.0767
##   Wed  0.0313  0.1853   0.1421   0.1889  0.1146   0.2517   0.0861
##   Thu  0.0341  0.1805   0.1370   0.1847  0.1123   0.2532   0.0980
##   Fri  0.0525  0.1658   0.1322   0.1802  0.1101   0.2358   0.1234
##   Sat  0.0905  0.0879   0.1398   0.1953  0.1098   0.2193   0.1574
## 
## $col_proportions
##      grp_2
## grp_1 1AM-5AM 5AM-9AM 9AM-12PM 12PM-4PM 4PM-6PM 6PM-10PM 10PM-1AM
##   Sun  0.2740  0.0694   0.1431   0.1467  0.1299   0.1050   0.1810
##   Mon  0.0808  0.1538   0.1295   0.1360  0.1424   0.1299   0.0873
##   Tue  0.0732  0.1724   0.1416   0.1395  0.1452   0.1477   0.0969
##   Wed  0.0820  0.1742   0.1452   0.1400  0.1437   0.1557   0.1126
##   Thu  0.0933  0.1769   0.1461   0.1429  0.1468   0.1633   0.1336
##   Fri  0.1471  0.1665   0.1444   0.1428  0.1475   0.1559   0.1725
##   Sat  0.2495  0.0867   0.1501   0.1521  0.1446   0.1425   0.2161
## 
## $average_by_group
##     1AM-5AM 5AM-9AM 9AM-12PM 12PM-4PM 4PM-6PM 6PM-10PM 10PM-1AM
## Sun    2.33    2.42     2.22     2.49    2.49     2.53     2.41
## Mon    2.93    2.42     2.51     2.56    2.47     2.51     2.72
## Tue    2.71    2.33     2.53     2.60    2.51     2.52     2.69
## Wed    2.75    2.34     2.54     2.73    2.61     2.52     2.62
## Thu    2.76    2.36     2.55     2.76    2.62     2.55     2.63
## Fri    2.71    2.36     2.47     2.65    2.53     2.42     2.54
## Sat    2.40    2.36     2.15     2.28    2.26     2.26     2.40</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">res$tip_amount$col_proportions <span class="co"># the next level has the statistics that the function outputs.</span></code></pre></div>
<pre><code>##      grp_2
## grp_1 1AM-5AM 5AM-9AM 9AM-12PM 12PM-4PM 4PM-6PM 6PM-10PM 10PM-1AM
##   Sun  0.2740  0.0694   0.1431   0.1467  0.1299   0.1050   0.1810
##   Mon  0.0808  0.1538   0.1295   0.1360  0.1424   0.1299   0.0873
##   Tue  0.0732  0.1724   0.1416   0.1395  0.1452   0.1477   0.0969
##   Wed  0.0820  0.1742   0.1452   0.1400  0.1437   0.1557   0.1126
##   Thu  0.0933  0.1769   0.1461   0.1429  0.1468   0.1633   0.1336
##   Fri  0.1471  0.1665   0.1444   0.1428  0.1475   0.1559   0.1725
##   Sat  0.2495  0.0867   0.1501   0.1521  0.1446   0.1425   0.2161</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">res$tip_amount$col_proportions[<span class="st">&quot;Mon&quot;</span>, <span class="st">&quot;9AM-12PM&quot;</span>]</code></pre></div>
<pre><code>## [1] 0.13</code></pre>
<p>Since <code>res</code> contains a lot of summaries, it might be a good idea to save it using <code>save</code>. Any R object can be saved with <code>save</code>. This way if our R session crashes we can reload the object with the <code>load</code> function.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">save</span>(res, <span class="dt">file =</span> <span class="st">&quot;res.RData&quot;</span>) <span class="co"># save this result</span>
<span class="kw">rm</span>(res) <span class="co"># it is now safe to delete `res` from the current session</span>
<span class="kw">load</span>(<span class="dt">file =</span> <span class="st">&quot;res.RData&quot;</span>) <span class="co"># we can use `load` to reopen it anytime we need it again</span>
<span class="kw">file.remove</span>(<span class="dt">file =</span> <span class="st">&quot;res.RData&quot;</span>) <span class="co"># delete the file</span></code></pre></div>
<pre><code>## [1] TRUE</code></pre>
<div id="exercises-12" class="section level3">
<h3><span class="header-section-number">5.3.1</span> Exercises</h3>
<p>Debug the summary function <code>my.summary</code> in the last section so that the trimmed mean returns the correct result.</p>
<p>HINT: Notice what <code>sort</code> does to missing values.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">sort</span>(<span class="kw">c</span>(<span class="dv">5</span>, <span class="dv">1</span>, <span class="ot">NA</span>, <span class="ot">NA</span>, <span class="dv">2</span>))</code></pre></div>
<pre><code>## [1] 1 2 5</code></pre>
</div>
<div id="solutions-10" class="section level3">
<h3><span class="header-section-number">5.3.2</span> Solutions</h3>
<p>This is a tricky type of “bug” because nothing in R went wrong and no error message was returned. Instead, we simply overlooked something in the code. As it turns out, when we pass a vector with missing values to <code>sort</code>, <code>sort</code> returns the sorted vector with the missing values <strong>removed</strong>. But if missing values are removed, then the length of the vector changes and we need to recompute it. This is a quick fix: we need to change <code>n &lt;- length(resp)</code> in the body of the function to <code>n &lt;- length(sorted_resp)</code>.</p>
</div>
</div>
<div id="data-summary-with-dplyr" class="section level2">
<h2><span class="header-section-number">5.4</span> Data summary with <code>dplyr</code></h2>
<p>When it comes to summarizing data, we have a lot of options. We covered just a few in the last section, but there are many more functions both in <code>base</code> R and packages. We will cover <code>dplyr</code> in this section, as an example of a third-party package. What makes <code>dplyr</code> very popular is the simple and streight-farward notation for creating increasing complex data pipelines.</p>
<p>First let’s review important functions in <code>dplyr</code>: <code>filter</code>, <code>mutate</code>, <code>transmute</code>, <code>group_by</code>, <code>select</code>, <code>slice</code>, <code>summarize</code>, <code>distinct</code>, <code>arrange</code>, <code>rename</code>, <code>inner_join</code>, <code>outer_join</code>, <code>left_join</code>. With each of the above function, we can either pass the data directly to the function or infer it from the the pipeline. Here’s an example of <code>filter</code> being used in both ways. In the first case we pass the data as the first argument to <code>filter</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(dplyr)
<span class="kw">head</span>(<span class="kw">filter</span>(nyc_taxi, fare_amount &gt;<span class="st"> </span><span class="dv">500</span>)) <span class="co"># pass data directly to the function</span></code></pre></div>
<pre><code>## # A tibble: 6 × 25
##       pickup_datetime    dropoff_datetime passenger_count trip_distance pickup_longitude
##                &lt;dttm&gt;              &lt;dttm&gt;           &lt;int&gt;         &lt;dbl&gt;            &lt;dbl&gt;
## 1 2016-06-08 16:40:58 2016-06-08 16:43:46               1           0.0            -73.9
## 2 2016-06-13 12:08:55 2016-06-13 12:09:45               1           0.4            -73.8
## 3 2016-06-22 14:53:04 2016-06-22 15:04:21               5           0.0               NA
## 4 2016-06-13 01:14:08 2016-06-13 01:15:34               1           0.0            -74.0
## 5 2016-06-30 09:28:53 2016-06-30 09:28:53               1           0.0            -73.9
## 6 2016-05-19 11:24:04 2016-05-20 10:14:22               2           0.0            -73.9
##   pickup_latitude rate_code_id dropoff_longitude dropoff_latitude payment_type
##             &lt;dbl&gt;       &lt;fctr&gt;             &lt;dbl&gt;            &lt;dbl&gt;       &lt;fctr&gt;
## 1            40.8   negotiated             -73.9             40.8         cash
## 2            40.6          JFK             -73.8             40.6           NA
## 3              NA     standard                NA               NA         cash
## 4            40.6   negotiated             -74.0             40.6         card
## 5            40.8     standard                NA               NA         cash
## 6            40.8     standard             -73.9             40.8         cash
##   fare_amount extra mta_tax tip_amount tolls_amount improvement_surcharge total_amount
##         &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt;      &lt;dbl&gt;        &lt;dbl&gt;                 &lt;dbl&gt;        &lt;dbl&gt;
## 1         550     0     0.0         NA            0                   0.3          550
## 2        8452     0     0.5         NA            0                   0.3         8453
## 3         726     0     0.5         NA            0                   0.3          726
## 4         950     0     0.0       49.7            0                   0.3            1
## 5      628545   488     0.5         NA            0                   0.3       629034
## 6         688     0     0.5         NA            0                   0.3          688
##   pickup_hour pickup_dow dropoff_hour dropoff_dow trip_duration pickup_nhood
##        &lt;fctr&gt;     &lt;fctr&gt;       &lt;fctr&gt;      &lt;fctr&gt;         &lt;int&gt;       &lt;fctr&gt;
## 1    12PM-4PM        Wed     12PM-4PM         Wed           168           NA
## 2    9AM-12PM        Mon     9AM-12PM         Mon            50           NA
## 3    12PM-4PM        Wed     12PM-4PM         Wed           677           NA
## 4    10PM-1AM        Mon     10PM-1AM         Mon            86           NA
## 5     5AM-9AM        Thu      5AM-9AM         Thu             0           NA
## 6    9AM-12PM        Thu     9AM-12PM         Fri         82218           NA
##   dropoff_nhood tip_percent
##          &lt;fctr&gt;       &lt;int&gt;
## 1            NA          NA
## 2            NA          NA
## 3            NA          NA
## 4            NA           4
## 5            NA          NA
## 6            NA          NA</code></pre>
<p>In the second case, we start a pipeline with the data, followed by the piping function <code>%&gt;%</code>, followed by <code>filter</code> which now inherits the data from the previous step and only needs the filtering condition.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">nyc_taxi %&gt;%<span class="st"> </span><span class="kw">filter</span>(fare_amount &gt;<span class="st"> </span><span class="dv">500</span>) %&gt;%<span class="st"> </span>head <span class="co"># infer the data from the pipeline</span></code></pre></div>
<pre><code>## # A tibble: 6 × 25
##       pickup_datetime    dropoff_datetime passenger_count trip_distance pickup_longitude
##                &lt;dttm&gt;              &lt;dttm&gt;           &lt;int&gt;         &lt;dbl&gt;            &lt;dbl&gt;
## 1 2016-06-08 16:40:58 2016-06-08 16:43:46               1           0.0            -73.9
## 2 2016-06-13 12:08:55 2016-06-13 12:09:45               1           0.4            -73.8
## 3 2016-06-22 14:53:04 2016-06-22 15:04:21               5           0.0               NA
## 4 2016-06-13 01:14:08 2016-06-13 01:15:34               1           0.0            -74.0
## 5 2016-06-30 09:28:53 2016-06-30 09:28:53               1           0.0            -73.9
## 6 2016-05-19 11:24:04 2016-05-20 10:14:22               2           0.0            -73.9
##   pickup_latitude rate_code_id dropoff_longitude dropoff_latitude payment_type
##             &lt;dbl&gt;       &lt;fctr&gt;             &lt;dbl&gt;            &lt;dbl&gt;       &lt;fctr&gt;
## 1            40.8   negotiated             -73.9             40.8         cash
## 2            40.6          JFK             -73.8             40.6           NA
## 3              NA     standard                NA               NA         cash
## 4            40.6   negotiated             -74.0             40.6         card
## 5            40.8     standard                NA               NA         cash
## 6            40.8     standard             -73.9             40.8         cash
##   fare_amount extra mta_tax tip_amount tolls_amount improvement_surcharge total_amount
##         &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt;      &lt;dbl&gt;        &lt;dbl&gt;                 &lt;dbl&gt;        &lt;dbl&gt;
## 1         550     0     0.0         NA            0                   0.3          550
## 2        8452     0     0.5         NA            0                   0.3         8453
## 3         726     0     0.5         NA            0                   0.3          726
## 4         950     0     0.0       49.7            0                   0.3            1
## 5      628545   488     0.5         NA            0                   0.3       629034
## 6         688     0     0.5         NA            0                   0.3          688
##   pickup_hour pickup_dow dropoff_hour dropoff_dow trip_duration pickup_nhood
##        &lt;fctr&gt;     &lt;fctr&gt;       &lt;fctr&gt;      &lt;fctr&gt;         &lt;int&gt;       &lt;fctr&gt;
## 1    12PM-4PM        Wed     12PM-4PM         Wed           168           NA
## 2    9AM-12PM        Mon     9AM-12PM         Mon            50           NA
## 3    12PM-4PM        Wed     12PM-4PM         Wed           677           NA
## 4    10PM-1AM        Mon     10PM-1AM         Mon            86           NA
## 5     5AM-9AM        Thu      5AM-9AM         Thu             0           NA
## 6    9AM-12PM        Thu     9AM-12PM         Fri         82218           NA
##   dropoff_nhood tip_percent
##          &lt;fctr&gt;       &lt;int&gt;
## 1            NA          NA
## 2            NA          NA
## 3            NA          NA
## 4            NA           4
## 5            NA          NA
## 6            NA          NA</code></pre>
<p>Piping is especially useful for longer pipelines. Here’s an example of a query without piping.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">summarize</span>( <span class="co"># (3)</span>
  <span class="kw">group_by</span>( <span class="co"># (2)</span>
    <span class="kw">filter</span>(nyc_taxi, fare_amount &gt;<span class="st"> </span><span class="dv">500</span>), <span class="co"># (1)</span>
  payment_type),
<span class="dt">ave_duration =</span> <span class="kw">mean</span>(trip_duration), <span class="dt">ave_distance =</span> <span class="kw">mean</span>(trip_distance))</code></pre></div>
<pre><code>## # A tibble: 3 × 3
##   payment_type ave_duration ave_distance
##         &lt;fctr&gt;        &lt;dbl&gt;        &lt;dbl&gt;
## 1         card         3808       39.867
## 2         cash        16531        0.104
## 3           NA          494        4.250</code></pre>
<p>To understand the query, we need to work from the inside out: 1. First filter the data to show only fare amounts above $500 2. Group the resulting data by payment type 3. For each group find average trip duration and trip distance</p>
<p>The same query, using piping, looks like this:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">nyc_taxi %&gt;%
<span class="st">  </span><span class="kw">filter</span>(fare_amount &gt;<span class="st"> </span><span class="dv">500</span>) %&gt;%<span class="st"> </span><span class="co"># (1)</span>
<span class="st">  </span><span class="kw">group_by</span>(payment_type) %&gt;%<span class="st"> </span><span class="co"># (2)</span>
<span class="st">  </span><span class="kw">summarize</span>(<span class="dt">ave_duration =</span> <span class="kw">mean</span>(trip_duration), <span class="dt">ave_distance =</span> <span class="kw">mean</span>(trip_distance)) <span class="co"># (3)</span></code></pre></div>
<pre><code>## # A tibble: 3 × 3
##   payment_type ave_duration ave_distance
##         &lt;fctr&gt;        &lt;dbl&gt;        &lt;dbl&gt;
## 1         card         3808       39.867
## 2         cash        16531        0.104
## 3           NA          494        4.250</code></pre>
<p>Instead of working from the inside out, piping allows us to read the code from top to bottom. This makes it easier (1) to understand what the query does and (2) to build upon the query.</p>
<p>The best way to learn <code>dplyr</code> is by example. So instead of covering functions one by one, we state some interesting queries and use <code>dplyr</code> to implement them. There are obvious parallels between <code>dplyr</code> and the SQL language, but important differences exist too. We point out some of those differences along the way.</p>
<div id="exercises-13" class="section level3">
<h3><span class="header-section-number">5.4.1</span> Exercises</h3>
<ol style="list-style-type: decimal">
<li>In the following query, we want to add a forth step: Sort the results by descending average trip duration. The <code>dplyr</code> function to sort is <code>arrange</code>. For example <code>arrange(data, x1, desc(x2))</code> will sort <code>data</code> by increasing values of <code>x1</code> and decreasing values of <code>x2</code> within each value of <code>x1</code>.</li>
</ol>
<p>Implement this forth step to both the code with and without the pipeline, both of which are shown here:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">summarize</span>( <span class="co"># (3)</span>
  <span class="kw">group_by</span>( <span class="co"># (2)</span>
    <span class="kw">filter</span>(nyc_taxi, fare_amount &gt;<span class="st"> </span><span class="dv">500</span>), <span class="co"># (1)</span>
  payment_type),
<span class="dt">ave_duration =</span> <span class="kw">mean</span>(trip_duration), <span class="dt">ave_distance =</span> <span class="kw">mean</span>(trip_distance))</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">nyc_taxi %&gt;%
<span class="kw">filter</span>(fare_amount &gt;<span class="st"> </span><span class="dv">500</span>) %&gt;%<span class="st"> </span><span class="co"># (1)</span>
<span class="kw">group_by</span>(payment_type) %&gt;%<span class="st"> </span><span class="co"># (2)</span>
<span class="kw">summarize</span>(<span class="dt">ave_duration =</span> <span class="kw">mean</span>(trip_duration), <span class="dt">ave_distance =</span> <span class="kw">mean</span>(trip_distance)) <span class="co"># (3)</span></code></pre></div>
<p>The remaining exercises are questions about the data that need to be translated into a <code>dplyr</code> pipeline. The goal of the exercise is two-fold: learn to break down a question into multiple pieces and learn to translate each piece into a line in <code>dplyr</code>, which together comprise the pipeline.</p>
<ol start="2" style="list-style-type: decimal">
<li><p>What are the pick-up times of the day and the days of the week with the highest average fare per mile of ride?</p></li>
<li><p>For each pick-up neighborhood, find the number and percentage of trips that “fan out” into other neighborhoods. Sort results by pickup neighborhood and descending percentage. Limit results to top 50 percent coverage. In other words, show only the top 50 percent of destinations for each pick-up neighborhood.</p></li>
<li><p>Are any dates missing from the data?</p></li>
<li><p>Find the 3 consecutive days with the most total number of trips?</p></li>
<li><p>Get the average, standard deviation, and mean absolute deviation of <code>trip_distance</code> and <code>trip_duration</code>, as well as the ratio of <code>trip_duration</code> over <code>trip_distance</code>. Results should be broken up by <code>pickup_nhood</code> and <code>dropoff_nhood</code>.</p></li>
</ol>
</div>
<div id="solutions-11" class="section level3">
<h3><span class="header-section-number">5.4.2</span> Solutions</h3>
<ol style="list-style-type: decimal">
<li>Without the pipeline function, we would have <code>arrange</code> as the outermost function:</li>
</ol>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">arrange</span>( <span class="co"># (4)</span>
  <span class="kw">summarize</span>( <span class="co"># (3)</span>
    <span class="kw">group_by</span>( <span class="co"># (2)</span>
      <span class="kw">filter</span>(nyc_taxi, fare_amount &gt;<span class="st"> </span><span class="dv">500</span>), <span class="co"># (1)</span>
    payment_type),
  <span class="dt">ave_duration =</span> <span class="kw">mean</span>(trip_duration), <span class="dt">ave_distance =</span> <span class="kw">mean</span>(trip_distance)),
<span class="kw">desc</span>(ave_duration))</code></pre></div>
<pre><code>## # A tibble: 3 × 3
##   payment_type ave_duration ave_distance
##         &lt;fctr&gt;        &lt;dbl&gt;        &lt;dbl&gt;
## 1         cash        16531        0.104
## 2         card         3808       39.867
## 3           NA          494        4.250</code></pre>
<p>With the pipeline function, we simply add the pipe to the end of <code>summarize</code> and add <code>arrange</code> as a new line to the end of the code:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">q1 &lt;-<span class="st"> </span>nyc_taxi %&gt;%
<span class="st">  </span><span class="kw">filter</span>(fare_amount &gt;<span class="st"> </span><span class="dv">500</span>) %&gt;%<span class="st"> </span><span class="co"># (1)</span>
<span class="st">  </span><span class="kw">group_by</span>(payment_type) %&gt;%<span class="st"> </span><span class="co"># (2)</span>
<span class="st">  </span><span class="kw">summarize</span>(<span class="dt">ave_duration =</span> <span class="kw">mean</span>(trip_duration), <span class="dt">ave_distance =</span> <span class="kw">mean</span>(trip_distance)) %&gt;%<span class="st"> </span><span class="co"># (3)</span>
<span class="st">  </span><span class="kw">arrange</span>(<span class="kw">desc</span>(ave_duration)) <span class="co"># (4)</span>

<span class="kw">head</span>(q1)</code></pre></div>
<pre><code>## # A tibble: 3 × 3
##   payment_type ave_duration ave_distance
##         &lt;fctr&gt;        &lt;dbl&gt;        &lt;dbl&gt;
## 1         cash        16531        0.104
## 2         card         3808       39.867
## 3           NA          494        4.250</code></pre>
<ol start="2" style="list-style-type: decimal">
<li>What are the times of the day and the days of the week with the highest fare per mile of ride?</li>
</ol>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">q2 &lt;-<span class="st"> </span>nyc_taxi %&gt;%
<span class="st">  </span><span class="kw">filter</span>(trip_distance &gt;<span class="st"> </span><span class="dv">0</span>) %&gt;%
<span class="st">  </span><span class="kw">group_by</span>(pickup_dow, pickup_hour) %&gt;%
<span class="st">  </span><span class="kw">summarize</span>(<span class="dt">ave_fare_per_mile =</span> <span class="kw">mean</span>(fare_amount /<span class="st"> </span>trip_distance, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>), <span class="dt">count =</span> <span class="kw">n</span>()) %&gt;%
<span class="st">  </span><span class="kw">group_by</span>() %&gt;%<span class="st"> </span><span class="co"># we &#39;reset&#39;, or remove, the group by, otherwise sorting won&#39;t work</span>
<span class="st">  </span><span class="kw">arrange</span>(<span class="kw">desc</span>(ave_fare_per_mile))

<span class="kw">head</span>(q2)</code></pre></div>
<pre><code>## # A tibble: 6 × 4
##   pickup_dow pickup_hour ave_fare_per_mile  count
##       &lt;fctr&gt;      &lt;fctr&gt;             &lt;dbl&gt;  &lt;int&gt;
## 1        Wed    12PM-4PM              7.97 161887
## 2        Wed    9AM-12PM              7.79 121956
## 3        Tue    12PM-4PM              7.73 161322
## 4        Thu    9AM-12PM              7.70 122612
## 5        Thu    12PM-4PM              7.62 165127
## 6        Tue    9AM-12PM              7.53 118885</code></pre>
<ol start="3" style="list-style-type: decimal">
<li>For each pick-up neighborhood, find the number and percentage of trips that “fan out” into other neighborhoods. Sort results by pickup neighborhood and descending percentage. Limit results to top 50 percent coverage. In other words, show only the top 50 percent of destinations for each pick-up neighborhood.</li>
</ol>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">q3 &lt;-<span class="st"> </span>nyc_taxi %&gt;%
<span class="st">  </span><span class="kw">filter</span>(!<span class="kw">is.na</span>(pickup_nhood) &amp;<span class="st"> </span>!<span class="kw">is.na</span>(dropoff_nhood)) %&gt;%
<span class="st">  </span><span class="kw">group_by</span>(pickup_nhood, dropoff_nhood) %&gt;%
<span class="st">  </span><span class="kw">summarize</span>(<span class="dt">count =</span> <span class="kw">n</span>()) %&gt;%
<span class="st">  </span><span class="kw">group_by</span>(pickup_nhood) %&gt;%
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">proportion =</span> <span class="kw">prop.table</span>(count),
         <span class="dt">cum.prop =</span> <span class="kw">order_by</span>(<span class="kw">desc</span>(proportion), 
         <span class="kw">cumsum</span>(proportion))) %&gt;%
<span class="st">  </span><span class="kw">group_by</span>() %&gt;%
<span class="st">  </span><span class="kw">arrange</span>(pickup_nhood, <span class="kw">desc</span>(proportion)) %&gt;%
<span class="st">  </span><span class="kw">group_by</span>(pickup_nhood) %&gt;%
<span class="st">  </span><span class="kw">filter</span>(<span class="kw">row_number</span>() &lt;<span class="st"> </span><span class="dv">11</span> |<span class="st"> </span>cum.prop &lt;<span class="st"> </span>.<span class="dv">50</span>)

<span class="kw">head</span>(q3)</code></pre></div>
<pre><code>## Source: local data frame [6 x 5]
## Groups: pickup_nhood [1]
## 
##   pickup_nhood     dropoff_nhood count proportion cum.prop
##         &lt;fctr&gt;            &lt;fctr&gt; &lt;int&gt;      &lt;dbl&gt;    &lt;dbl&gt;
## 1 West Village           Chelsea 20870     0.1622    0.162
## 2 West Village           Midtown 14934     0.1161    0.278
## 3 West Village Greenwich Village 11403     0.0886    0.367
## 4 West Village          Gramercy 10077     0.0783    0.445
## 5 West Village  Garment District  7970     0.0619    0.507
## 6 West Village      West Village  7232     0.0562    0.563</code></pre>
<ol start="4" style="list-style-type: decimal">
<li>Are any dates missing from the data?</li>
</ol>
<p>There are many ways to answer this query and we cover three because each way highlights an important point. The first way consists sorting the data by date and using the <code>lag</code> function to find the difference between each date and the date proceeding it. If this difference is greater than 1, then we skipped one or more days.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">nyc_taxi %&gt;%
<span class="st">  </span><span class="kw">select</span>(pickup_datetime) %&gt;%
<span class="st">  </span><span class="kw">distinct</span>(<span class="dt">date =</span> <span class="kw">as.Date</span>(pickup_datetime)) %&gt;%
<span class="st">  </span><span class="kw">arrange</span>(date) %&gt;%<span class="st"> </span><span class="co"># this is an important step!</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">diff =</span> date -<span class="st"> </span><span class="kw">lag</span>(date)) %&gt;%
<span class="st">  </span><span class="kw">arrange</span>(<span class="kw">desc</span>(diff))</code></pre></div>
<pre><code>## # A tibble: 182 × 2
##          date   diff
##        &lt;date&gt; &lt;time&gt;
## 1  2016-01-02 1 days
## 2  2016-01-03 1 days
## 3  2016-01-04 1 days
## 4  2016-01-05 1 days
## 5  2016-01-06 1 days
## 6  2016-01-07 1 days
## 7  2016-01-08 1 days
## 8  2016-01-09 1 days
## 9  2016-01-10 1 days
## 10 2016-01-11 1 days
## # ... with 172 more rows</code></pre>
<p>The second solution is more involved. First we create a <code>data.frame</code> of all dates available in <code>nyc_taxi</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">nyc_taxi %&gt;%
<span class="st">  </span><span class="kw">select</span>(pickup_datetime) %&gt;%
<span class="st">  </span><span class="kw">distinct</span>(<span class="dt">date =</span> <span class="kw">as.Date</span>(pickup_datetime)) %&gt;%
<span class="st">  </span><span class="kw">filter</span>(!<span class="kw">is.na</span>(date)) -&gt;<span class="st"> </span>data_dates</code></pre></div>
<p>Then we create a new <code>data.frame</code> of all dates that span the time range in the data. We can use <code>seq</code> to do that.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">start_date &lt;-<span class="st"> </span><span class="kw">min</span>(data_dates$date)
end_date &lt;-<span class="st"> </span><span class="kw">max</span>(data_dates$date)
all_dates &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">date =</span> <span class="kw">seq</span>(start_date, end_date, <span class="dt">by =</span> <span class="st">&#39;1 day&#39;</span>))</code></pre></div>
<p>Finally, we ask for the “anti-join” of the two datasets. An anti-join is the opposite of an left join: any keys present in left dataset but not the right are returned.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">anti_join</span>(all_dates, data_dates, <span class="dt">by =</span> <span class="st">&#39;date&#39;</span>) <span class="co"># an anti-join is the reverse of an left join</span></code></pre></div>
<pre><code>## [1] date
## &lt;0 rows&gt; (or 0-length row.names)</code></pre>
<p>The third solution consists of comparing the number of days between the earliest and latest dates in the data to the number of days we expect to see if no days were missing.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">nyc_taxi %&gt;%
<span class="st">  </span><span class="kw">distinct</span>(<span class="dt">date =</span> <span class="kw">as.Date</span>(pickup_datetime)) %&gt;%
<span class="st">  </span><span class="kw">filter</span>(<span class="kw">is.na</span>(date) ==<span class="st"> </span><span class="ot">FALSE</span>) %&gt;%
<span class="st">  </span><span class="kw">summarize</span>(<span class="dt">min_date =</span> <span class="kw">min</span>(date), <span class="dt">max_date =</span> <span class="kw">max</span>(date), <span class="dt">n =</span> <span class="kw">n</span>()) %&gt;%
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">diff =</span> max_date -<span class="st"> </span>min_date +<span class="st"> </span><span class="dv">1</span>)</code></pre></div>
<pre><code>## # A tibble: 1 × 4
##     min_date   max_date     n     diff
##       &lt;date&gt;     &lt;date&gt; &lt;int&gt;   &lt;time&gt;
## 1 2016-01-01 2016-06-30   182 182 days</code></pre>
<ol start="5" style="list-style-type: decimal">
<li>Find the 3 consecutive days with the most total number of trips?</li>
</ol>
<p>This is a hard exercise. In query 3, we need to compute rolling statistics (rolling sums in this case). There are functions in R that we can use for that purpose, but one of the advantages of R is that writing our own functions is not always that hard. Write a function called <code>rolling_sum</code> that takes in two arguments: <code>x</code> and <code>nlag</code>: <code>x</code> is a numeric vector <code>nlags</code> is a positive integer for the number of days we’re rolling by. The function returns a vector of the same length as <code>x</code>, of the rolling sum of <code>x</code> over <code>nlag</code> elements.</p>
<p>For example, given <code>x &lt;- 1:6</code> and <code>n &lt;- 2</code> as inputs, the function returns <code>c(NA, NA, 6, 9, 12, 15)</code></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">rolling_sum &lt;-<span class="st"> </span>function(x, nlag) {
  <span class="kw">stopifnot</span>(nlag &gt;<span class="st"> </span><span class="dv">0</span>, nlag &lt;<span class="st"> </span><span class="kw">length</span>(x))
  <span class="kw">c</span>(<span class="kw">rep</span>(<span class="ot">NA</span>, nlag), <span class="kw">sapply</span>((nlag +<span class="st"> </span><span class="dv">1</span>):<span class="kw">length</span>(x), function(ii) <span class="kw">sum</span>(x[(ii -<span class="st"> </span>nlag):ii])))
}
<span class="co"># Here&#39;s an easy test to see if things seem to be working:</span>
<span class="kw">rolling_sum</span>(<span class="kw">rep</span>(<span class="dv">1</span>, <span class="dv">100</span>), <span class="dv">10</span>) <span class="co"># Should return 10 NAs followed by 90 entries that are all 11</span></code></pre></div>
<pre><code>##   [1] NA NA NA NA NA NA NA NA NA NA 11 11 11 11 11 11 11 11 11 11 11 11 11 11 11 11 11 11
##  [29] 11 11 11 11 11 11 11 11 11 11 11 11 11 11 11 11 11 11 11 11 11 11 11 11 11 11 11 11
##  [57] 11 11 11 11 11 11 11 11 11 11 11 11 11 11 11 11 11 11 11 11 11 11 11 11 11 11 11 11
##  [85] 11 11 11 11 11 11 11 11 11 11 11 11 11 11 11 11</code></pre>
<p>We can even go one step further. Let’s rename the function to <code>rolling</code> and add a third argument to it called <code>FUN</code>, allowing us to specify any rolling function, not just <code>sum</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">rolling &lt;-<span class="st"> </span>function(x, nlag, FUN) {
  <span class="kw">stopifnot</span>(nlag &gt;<span class="st"> </span><span class="dv">0</span>, nlag &lt;<span class="st"> </span><span class="kw">length</span>(x))
  <span class="kw">c</span>(<span class="kw">rep</span>(<span class="ot">NA</span>, nlag), <span class="kw">sapply</span>((nlag +<span class="st"> </span><span class="dv">1</span>):<span class="kw">length</span>(x), function(ii) <span class="kw">FUN</span>(x[(ii -<span class="st"> </span>nlag):ii])))
}</code></pre></div>
<p>We can now use <code>rolling</code> to find the 3 consecutive days with the most total number of trips.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">nlag &lt;-<span class="st"> </span><span class="dv">2</span>

q5 &lt;-<span class="st"> </span>nyc_taxi %&gt;%
<span class="st">  </span><span class="kw">filter</span>(!<span class="kw">is.na</span>(pickup_datetime)) %&gt;%
<span class="st">  </span><span class="kw">transmute</span>(<span class="dt">end_date =</span> <span class="kw">as.Date</span>(pickup_datetime)) %&gt;%
<span class="st">  </span><span class="kw">group_by</span>(end_date) %&gt;%
<span class="st">  </span><span class="kw">summarize</span>(<span class="dt">n =</span> <span class="kw">n</span>()) %&gt;%
<span class="st">  </span><span class="kw">group_by</span>() %&gt;%
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">start_date =</span> end_date -<span class="st"> </span>nlag, <span class="dt">cn =</span> <span class="kw">rolling</span>(n, nlag, sum)) %&gt;%
<span class="st">  </span><span class="kw">arrange</span>(<span class="kw">desc</span>(cn)) %&gt;%
<span class="st">  </span><span class="kw">select</span>(start_date, end_date, n, cn) %&gt;%
<span class="st">  </span><span class="kw">top_n</span>(<span class="dv">10</span>, cn)

<span class="kw">head</span>(q5)</code></pre></div>
<pre><code>## # A tibble: 6 × 4
##   start_date   end_date     n     cn
##       &lt;date&gt;     &lt;date&gt; &lt;int&gt;  &lt;int&gt;
## 1 2016-02-11 2016-02-13 39240 115172
## 2 2016-02-25 2016-02-27 38712 113417
## 3 2016-01-28 2016-01-30 39783 113120
## 4 2016-02-12 2016-02-14 35352 112826
## 5 2016-01-14 2016-01-16 37685 111217
## 6 2016-01-29 2016-01-31 33196 110965</code></pre>
<p>As it turns out, there’s already a similar function we could have used, called <code>rollapply</code> in the <code>zoo</code> package. Sometimes it pays off to take the time and search for the right function, especially if what we’re trying to do is common enough that we should not have to “reinvent the wheel”.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(zoo)
<span class="kw">rollapply</span>(<span class="dv">1</span>:<span class="dv">10</span>, <span class="dv">3</span>, sum, <span class="dt">fill =</span> <span class="ot">NA</span>, <span class="dt">align =</span> <span class="st">&#39;right&#39;</span>)</code></pre></div>
<pre><code>##  [1] NA NA  6  9 12 15 18 21 24 27</code></pre>
<p>Here’s an alternative solution: We could have run the above query without <code>rolling</code> by just using the <code>lag</code> function, but the code is more complicated and harder to automate it for different values of <code>nlag</code> or for different functions other than <code>sum</code>. Here’s how we can rewrite the above query with <code>lag</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">q5 &lt;-<span class="st"> </span>nyc_taxi %&gt;%
<span class="st">  </span><span class="kw">filter</span>(!<span class="kw">is.na</span>(pickup_datetime)) %&gt;%
<span class="st">  </span><span class="kw">transmute</span>(<span class="dt">end_date =</span> <span class="kw">as.Date</span>(pickup_datetime)) %&gt;%
<span class="st">  </span><span class="kw">group_by</span>(end_date) %&gt;%
<span class="st">  </span><span class="kw">summarize</span>(<span class="dt">n =</span> <span class="kw">n</span>()) %&gt;%
<span class="st">  </span><span class="kw">group_by</span>() %&gt;%
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">start_date =</span> end_date -<span class="st"> </span><span class="dv">3</span>,
  <span class="dt">n_lag_1 =</span> <span class="kw">lag</span>(n), <span class="dt">n_lag_2 =</span> <span class="kw">lag</span>(n, <span class="dv">2</span>),
  <span class="dt">cn =</span> n +<span class="st"> </span>n_lag_1 +<span class="st"> </span>n_lag_2) %&gt;%
<span class="st">  </span><span class="kw">arrange</span>(<span class="kw">desc</span>(cn)) %&gt;%
<span class="st">  </span><span class="kw">select</span>(start_date, end_date, n, cn) %&gt;%
<span class="st">  </span><span class="kw">top_n</span>(<span class="dv">10</span>, cn)

<span class="kw">head</span>(q5)</code></pre></div>
<pre><code>## # A tibble: 6 × 4
##   start_date   end_date     n     cn
##       &lt;date&gt;     &lt;date&gt; &lt;int&gt;  &lt;int&gt;
## 1 2016-02-10 2016-02-13 39240 115172
## 2 2016-02-24 2016-02-27 38712 113417
## 3 2016-01-27 2016-01-30 39783 113120
## 4 2016-02-11 2016-02-14 35352 112826
## 5 2016-01-13 2016-01-16 37685 111217
## 6 2016-01-28 2016-01-31 33196 110965</code></pre>
<ol start="6" style="list-style-type: decimal">
<li>Get the average, standard deviation, and mean absolute deviation of <code>trip_distance</code> and <code>trip_duration</code>, as well as the ratio of <code>trip_duration</code> over <code>trip_distance</code>. Results should be broken up by <code>pickup_nhood</code> and <code>dropoff_nhood</code>.</li>
</ol>
<p>Here’s how we compute the mean absolute deviation:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">mad &lt;-<span class="st"> </span>function(x) <span class="kw">mean</span>(<span class="kw">abs</span>(x -<span class="st"> </span><span class="kw">median</span>(x))) <span class="co"># one-liner functions don&#39;t need curly braces</span></code></pre></div>
<p>This query can easily be written with the tools we learned so far.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">q6 &lt;-<span class="st"> </span>nyc_taxi %&gt;%
<span class="st">  </span><span class="kw">filter</span>(!<span class="kw">is.na</span>(pickup_nhood) &amp;<span class="st"> </span>!<span class="kw">is.na</span>(dropoff_nhood)) %&gt;%
<span class="st">  </span><span class="kw">group_by</span>(pickup_nhood, dropoff_nhood) %&gt;%
<span class="st">  </span><span class="kw">summarize</span>(<span class="dt">mean_trip_distance =</span> <span class="kw">mean</span>(trip_distance, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>),
            <span class="dt">mean_trip_duration =</span> <span class="kw">mean</span>(trip_duration, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>),
            <span class="dt">sd_trip_distance =</span> <span class="kw">sd</span>(trip_distance, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>),
            <span class="dt">sd_trip_duration =</span> <span class="kw">sd</span>(trip_duration, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>),
            <span class="dt">mad_trip_distance =</span> <span class="kw">mad</span>(trip_distance),
            <span class="dt">mad_trip_duration =</span> <span class="kw">mad</span>(trip_duration))

<span class="kw">head</span>(q6)</code></pre></div>
<pre><code>## Source: local data frame [6 x 8]
## Groups: pickup_nhood [1]
## 
##   pickup_nhood dropoff_nhood mean_trip_distance mean_trip_duration sd_trip_distance
##         &lt;fctr&gt;        &lt;fctr&gt;              &lt;dbl&gt;              &lt;dbl&gt;            &lt;dbl&gt;
## 1 West Village  West Village              0.679                401            0.959
## 2 West Village  East Village              1.596                872            0.457
## 3 West Village  Battery Park              1.972                664            0.551
## 4 West Village Carnegie Hill              5.405               1593            0.699
## 5 West Village      Gramercy              1.699                813            0.502
## 6 West Village          Soho              1.213                648            0.431
##   sd_trip_duration mad_trip_distance mad_trip_duration
##              &lt;dbl&gt;             &lt;dbl&gt;             &lt;dbl&gt;
## 1             3171             0.356               262
## 2             3175             0.304               314
## 3             3088             0.385               242
## 4              529             0.584               387
## 5             2701             0.362               296
## 6             2782             0.307               284</code></pre>
<p>You may have noticed that the query we wrote in the last exercise was a little tedious and repetitive. Let’s now see a way of rewriting the query using some “shortcut” functions available in <code>dplyr</code>:</p>
<ul>
<li>When we apply the same summary function(s) to the same column(s) of the data, we can save a lot of time typing by using <code>summarize_each</code> instead of <code>summarize</code>. There is also a <code>mutate_each</code> function.</li>
<li>We can select <code>trip_distance</code> and <code>trip_duration</code> automatically using <code>starts_with('trip_')</code>, since they are the only columns that begin with that prefix, this can be a time-saver if we are selecting lots of columns at once (and we named them in a smart way). There are other helper functions called <code>ends_with</code> and <code>contains</code>.</li>
<li>Instead of defining the <code>mad</code> function separately, we can define it in-line. In fact, there’s a shortcut whereby we just name the function and provide the body of the function, replacing <code>x</code> with a period.</li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">q6 &lt;-<span class="st"> </span>nyc_taxi %&gt;%
<span class="st">  </span><span class="kw">filter</span>(!<span class="kw">is.na</span>(pickup_nhood) &amp;<span class="st"> </span>!<span class="kw">is.na</span>(dropoff_nhood)) %&gt;%
<span class="st">  </span><span class="kw">group_by</span>(pickup_nhood, dropoff_nhood) %&gt;%
<span class="st">  </span><span class="kw">summarize_each</span>(
    <span class="kw">funs</span>(mean, sd, <span class="dt">mad =</span> <span class="kw">mean</span>(<span class="kw">abs</span>(. -<span class="st"> </span><span class="kw">median</span>(.)))), <span class="co"># all the functions that we apply to the data are   listed here</span>
    <span class="kw">starts_with</span>(<span class="st">&#39;trip_&#39;</span>), <span class="co"># `trip_distance` and `trip_duration` are the only columns that start with `trip_`</span>
    <span class="dt">wait_per_mile =</span> trip_duration /<span class="st"> </span>trip_distance) <span class="co"># `duration_over_dist` is created on the fly</span>

<span class="kw">head</span>(q6)</code></pre></div>
<pre><code>## Source: local data frame [6 x 11]
## Groups: pickup_nhood [1]
## 
##   pickup_nhood dropoff_nhood trip_distance_mean trip_duration_mean wait_per_mile_mean
##         &lt;fctr&gt;        &lt;fctr&gt;              &lt;dbl&gt;              &lt;dbl&gt;              &lt;dbl&gt;
## 1 West Village  West Village              0.679                401                -74
## 2 West Village  East Village              1.596                872                -74
## 3 West Village  Battery Park              1.972                664                -74
## 4 West Village Carnegie Hill              5.405               1593                -74
## 5 West Village      Gramercy              1.699                813                -74
## 6 West Village          Soho              1.213                648                -74
##   trip_distance_sd trip_duration_sd wait_per_mile_sd trip_distance_mad trip_duration_mad
##              &lt;dbl&gt;            &lt;dbl&gt;            &lt;dbl&gt;             &lt;dbl&gt;             &lt;dbl&gt;
## 1            0.959             3171          0.00202             0.356               262
## 2            0.457             3175          0.00216             0.304               314
## 3            0.551             3088          0.00181             0.385               242
## 4            0.699              529          0.00204             0.584               387
## 5            0.502             2701          0.00198             0.362               296
## 6            0.431             2782          0.00181             0.307               284
##   wait_per_mile_mad
##               &lt;dbl&gt;
## 1           0.00153
## 2           0.00174
## 3           0.00142
## 4           0.00160
## 5           0.00153
## 6           0.00140</code></pre>
<p>We can do far more with <code>dplyr</code> but we leave it at this for an introduction. The goal was to give the user enough <code>dplyr</code> to develop an appreciation and be inspired to learn more.</p>

</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="creating-new-features.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="review.html" class="navigation navigation-next " aria-label="Next page""><i class="fa fa-angle-right"></i></a>

<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"google": false,
"weibo": false,
"instapper": false,
"vk": false,
"all": ["facebook", "google", "twitter", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
