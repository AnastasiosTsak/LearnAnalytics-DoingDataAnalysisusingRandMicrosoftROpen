<!DOCTYPE html>
<html >

<head>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>R Deep-dive</title>
  <meta content="text/html; charset=UTF-8" http-equiv="Content-Type">
  <meta name="description" content="This is a minimal example of using the bookdown package to write a book. The output format for this example is bookdown::gitbook.">
  <meta name="generator" content="bookdown 0.3 and GitBook 2.6.7">

  <meta property="og:title" content="R Deep-dive" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="This is a minimal example of using the bookdown package to write a book. The output format for this example is bookdown::gitbook." />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="R Deep-dive" />
  
  <meta name="twitter:description" content="This is a minimal example of using the bookdown package to write a book. The output format for this example is bookdown::gitbook." />
  

<meta name="author" content="Seth Mottaghinejad">


<meta name="date" content="2017-01-25">

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
  
<link rel="prev" href="cleaning-the-data.html">
<link rel="next" href="data-summary-and-analysis.html">

<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />









<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>

</head>

<body>


  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="1" data-path="getting-started.html"><a href="getting-started.html"><i class="fa fa-check"></i><b>1</b> Getting started</a><ul>
<li class="chapter" data-level="1.1" data-path="getting-started.html"><a href="getting-started.html#loading-packages"><i class="fa fa-check"></i><b>1.1</b> Loading packages</a></li>
<li class="chapter" data-level="1.2" data-path="getting-started.html"><a href="getting-started.html#loading-data-into-r"><i class="fa fa-check"></i><b>1.2</b> Loading data into R</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="inspecting-the-data.html"><a href="inspecting-the-data.html"><i class="fa fa-check"></i><b>2</b> Inspecting the data</a><ul>
<li class="chapter" data-level="2.1" data-path="inspecting-the-data.html"><a href="inspecting-the-data.html#basic-queries"><i class="fa fa-check"></i><b>2.1</b> Basic queries</a></li>
<li class="chapter" data-level="2.2" data-path="inspecting-the-data.html"><a href="inspecting-the-data.html#more-on-querying-data"><i class="fa fa-check"></i><b>2.2</b> More on querying data</a><ul>
<li class="chapter" data-level="2.2.1" data-path="inspecting-the-data.html"><a href="inspecting-the-data.html#exercises"><i class="fa fa-check"></i><b>2.2.1</b> Exercises</a></li>
<li class="chapter" data-level="2.2.2" data-path="inspecting-the-data.html"><a href="inspecting-the-data.html#solutions"><i class="fa fa-check"></i><b>2.2.2</b> Solutions</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="inspecting-the-data.html"><a href="inspecting-the-data.html#basic-summaries"><i class="fa fa-check"></i><b>2.3</b> Basic summaries</a><ul>
<li class="chapter" data-level="2.3.1" data-path="inspecting-the-data.html"><a href="inspecting-the-data.html#exercises-1"><i class="fa fa-check"></i><b>2.3.1</b> Exercises</a></li>
<li class="chapter" data-level="2.3.2" data-path="inspecting-the-data.html"><a href="inspecting-the-data.html#solutions-1"><i class="fa fa-check"></i><b>2.3.2</b> Solutions</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="cleaning-the-data.html"><a href="cleaning-the-data.html"><i class="fa fa-check"></i><b>3</b> Cleaning the data</a><ul>
<li class="chapter" data-level="3.0.1" data-path="cleaning-the-data.html"><a href="cleaning-the-data.html#exercises-2"><i class="fa fa-check"></i><b>3.0.1</b> Exercises</a></li>
<li class="chapter" data-level="3.0.2" data-path="cleaning-the-data.html"><a href="cleaning-the-data.html#solutions-2"><i class="fa fa-check"></i><b>3.0.2</b> Solutions</a></li>
<li class="chapter" data-level="3.1" data-path="cleaning-the-data.html"><a href="cleaning-the-data.html#dealing-with-datetimes"><i class="fa fa-check"></i><b>3.1</b> Dealing with datetimes</a></li>
<li class="chapter" data-level="3.2" data-path="cleaning-the-data.html"><a href="cleaning-the-data.html#dealing-with-factors"><i class="fa fa-check"></i><b>3.2</b> Dealing with factors</a><ul>
<li class="chapter" data-level="3.2.1" data-path="cleaning-the-data.html"><a href="cleaning-the-data.html#exercises-3"><i class="fa fa-check"></i><b>3.2.1</b> Exercises</a></li>
<li class="chapter" data-level="3.2.2" data-path="cleaning-the-data.html"><a href="cleaning-the-data.html#solutions-3"><i class="fa fa-check"></i><b>3.2.2</b> Solutions</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="cleaning-the-data.html"><a href="cleaning-the-data.html#being-more-efficient"><i class="fa fa-check"></i><b>3.3</b> Being more efficient</a><ul>
<li class="chapter" data-level="3.3.1" data-path="cleaning-the-data.html"><a href="cleaning-the-data.html#exercises-4"><i class="fa fa-check"></i><b>3.3.1</b> Exercises</a></li>
<li class="chapter" data-level="3.3.2" data-path="cleaning-the-data.html"><a href="cleaning-the-data.html#solutions-4"><i class="fa fa-check"></i><b>3.3.2</b> Solutions</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="creating-new-features.html"><a href="creating-new-features.html"><i class="fa fa-check"></i><b>4</b> Creating new features</a><ul>
<li class="chapter" data-level="4.0.1" data-path="creating-new-features.html"><a href="creating-new-features.html#exercises-5"><i class="fa fa-check"></i><b>4.0.1</b> Exercises</a></li>
<li class="chapter" data-level="4.1" data-path="creating-new-features.html"><a href="creating-new-features.html#date-and-time-features"><i class="fa fa-check"></i><b>4.1</b> Date and time features</a></li>
<li class="chapter" data-level="4.2" data-path="creating-new-features.html"><a href="creating-new-features.html#geographical-features"><i class="fa fa-check"></i><b>4.2</b> Geographical features</a><ul>
<li class="chapter" data-level="4.2.1" data-path="creating-new-features.html"><a href="creating-new-features.html#exercises-6"><i class="fa fa-check"></i><b>4.2.1</b> Exercises</a></li>
<li class="chapter" data-level="4.2.2" data-path="creating-new-features.html"><a href="creating-new-features.html#solutions-5"><i class="fa fa-check"></i><b>4.2.2</b> Solutions</a></li>
</ul></li>
<li class="chapter" data-level="4.3" data-path="creating-new-features.html"><a href="creating-new-features.html#creating-a-function"><i class="fa fa-check"></i><b>4.3</b> Creating a function</a><ul>
<li class="chapter" data-level="4.3.1" data-path="creating-new-features.html"><a href="creating-new-features.html#exercises-7"><i class="fa fa-check"></i><b>4.3.1</b> Exercises</a></li>
<li class="chapter" data-level="4.3.2" data-path="creating-new-features.html"><a href="creating-new-features.html#solution"><i class="fa fa-check"></i><b>4.3.2</b> Solution</a></li>
<li class="chapter" data-level="4.3.3" data-path="creating-new-features.html"><a href="creating-new-features.html#exercises-8"><i class="fa fa-check"></i><b>4.3.3</b> Exercises</a></li>
<li class="chapter" data-level="4.3.4" data-path="creating-new-features.html"><a href="creating-new-features.html#solutions-6"><i class="fa fa-check"></i><b>4.3.4</b> Solutions</a></li>
</ul></li>
<li class="chapter" data-level="4.4" data-path="creating-new-features.html"><a href="creating-new-features.html#tipping-behavior"><i class="fa fa-check"></i><b>4.4</b> Tipping behavior</a><ul>
<li class="chapter" data-level="4.4.1" data-path="creating-new-features.html"><a href="creating-new-features.html#exercises-9"><i class="fa fa-check"></i><b>4.4.1</b> Exercises</a></li>
<li class="chapter" data-level="4.4.2" data-path="creating-new-features.html"><a href="creating-new-features.html#solutions-7"><i class="fa fa-check"></i><b>4.4.2</b> Solutions</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="data-summary-and-analysis.html"><a href="data-summary-and-analysis.html"><i class="fa fa-check"></i><b>5</b> Data summary and analysis</a><ul>
<li class="chapter" data-level="5.1" data-path="data-summary-and-analysis.html"><a href="data-summary-and-analysis.html#summary-functions"><i class="fa fa-check"></i><b>5.1</b> Summary functions</a><ul>
<li class="chapter" data-level="5.1.1" data-path="data-summary-and-analysis.html"><a href="data-summary-and-analysis.html#exercises-10"><i class="fa fa-check"></i><b>5.1.1</b> Exercises</a></li>
<li class="chapter" data-level="5.1.2" data-path="data-summary-and-analysis.html"><a href="data-summary-and-analysis.html#solutions-8"><i class="fa fa-check"></i><b>5.1.2</b> Solutions</a></li>
</ul></li>
<li class="chapter" data-level="5.2" data-path="data-summary-and-analysis.html"><a href="data-summary-and-analysis.html#data-summary-in-base-r"><i class="fa fa-check"></i><b>5.2</b> Data summary in <code>base</code> R</a><ul>
<li class="chapter" data-level="5.2.1" data-path="data-summary-and-analysis.html"><a href="data-summary-and-analysis.html#exercises-11"><i class="fa fa-check"></i><b>5.2.1</b> Exercises</a></li>
<li class="chapter" data-level="5.2.2" data-path="data-summary-and-analysis.html"><a href="data-summary-and-analysis.html#solutions-9"><i class="fa fa-check"></i><b>5.2.2</b> Solutions</a></li>
</ul></li>
<li class="chapter" data-level="5.3" data-path="data-summary-and-analysis.html"><a href="data-summary-and-analysis.html#writing-summary-functions"><i class="fa fa-check"></i><b>5.3</b> Writing summary functions</a><ul>
<li class="chapter" data-level="5.3.1" data-path="data-summary-and-analysis.html"><a href="data-summary-and-analysis.html#exercises-12"><i class="fa fa-check"></i><b>5.3.1</b> Exercises</a></li>
<li class="chapter" data-level="5.3.2" data-path="data-summary-and-analysis.html"><a href="data-summary-and-analysis.html#solutions-10"><i class="fa fa-check"></i><b>5.3.2</b> Solutions</a></li>
</ul></li>
<li class="chapter" data-level="5.4" data-path="data-summary-and-analysis.html"><a href="data-summary-and-analysis.html#data-summary-with-dplyr"><i class="fa fa-check"></i><b>5.4</b> Data summary with <code>dplyr</code></a><ul>
<li class="chapter" data-level="5.4.1" data-path="data-summary-and-analysis.html"><a href="data-summary-and-analysis.html#exercises-13"><i class="fa fa-check"></i><b>5.4.1</b> Exercises</a></li>
<li class="chapter" data-level="5.4.2" data-path="data-summary-and-analysis.html"><a href="data-summary-and-analysis.html#solutions-11"><i class="fa fa-check"></i><b>5.4.2</b> Solutions</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="review.html"><a href="review.html"><i class="fa fa-check"></i><b>6</b> Review</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">R Deep-dive</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="creating-new-features" class="section level1">
<h1><span class="header-section-number">4</span> Creating new features</h1>
<p>Feature creation and feature selection are can be some of the most time-consuming part of model-building. It is often the place where the interplay between technical knowledge (for example about the models we intend to build) and business or domain knowledge (data requirements and how the analysis will be put to use) is at the forefront.</p>
<p>Let’s review our workflow so far:</p>
<ol style="list-style-type: decimal">
<li>load all the data (and combine them if necessary)</li>
<li>inspect the data in preparation cleaning it</li>
<li>clean the data in preparation for analysis</li>
<li><strong>add any interesting features or columns as far as they pertain to the analysis</strong></li>
<li>find ways to analyze or summarize the data and report your findings</li>
</ol>
<div id="exercises-5" class="section level3">
<h3><span class="header-section-number">4.0.1</span> Exercises</h3>
<p>Features extraction is the process of creating new (and interesting) columns in our data out of the existing columns. Sometimes new features can be directly extracted from one of several columns in the data. For example, we can extract the day of the week from <code>pickup_datetime</code> and <code>dropoff_datetime</code>. Sometimes new features rely on third-party data. For example, we could have a <code>holiday_flag</code> column to know which dates were holidays.</p>
<p>Let’s take a look at the data as it now stands.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">head</span>(nyc_taxi)</code></pre></div>
<pre><code>## # A tibble: 6 × 17
##       pickup_datetime    dropoff_datetime passenger_count trip_distance pickup_longitude
##                &lt;dttm&gt;              &lt;dttm&gt;           &lt;int&gt;         &lt;dbl&gt;            &lt;dbl&gt;
## 1 2016-06-21 21:33:52 2016-06-21 21:34:40               5          0.40              -74
## 2 2016-06-08 09:52:19 2016-06-08 10:19:55               1          5.20              -74
## 3 2016-06-14 23:27:22 2016-06-14 23:35:05               1          2.10              -74
## 4 2016-06-12 20:13:12 2016-06-12 20:18:53               5          2.23              -74
## 5 2016-06-10 23:40:21 2016-06-11 00:05:14               3          2.72              -74
## 6 2016-06-28 16:46:23 2016-06-28 16:54:57               1          1.30              -74
##   pickup_latitude rate_code_id dropoff_longitude dropoff_latitude payment_type
##             &lt;dbl&gt;       &lt;fctr&gt;             &lt;dbl&gt;            &lt;dbl&gt;       &lt;fctr&gt;
## 1            40.7     standard               -74             40.7         card
## 2            40.8     standard               -74             40.8         cash
## 3            40.7     standard               -74             40.7         card
## 4            40.8     standard               -74             40.8         card
## 5            40.7     standard               -74             40.7         card
## 6            40.7     standard               -74             40.7         cash
##   fare_amount extra mta_tax tip_amount tolls_amount improvement_surcharge total_amount
##         &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt;      &lt;dbl&gt;        &lt;dbl&gt;                 &lt;dbl&gt;        &lt;dbl&gt;
## 1         3.0   0.5     0.5       0.86            0                   0.3         5.16
## 2        21.5   0.0     0.5       0.00            0                   0.3        22.30
## 3         9.0   0.5     0.5       1.50            0                   0.3        11.80
## 4         8.0   0.5     0.5       2.79            0                   0.3        12.09
## 5        17.0   0.5     0.5       3.66            0                   0.3        21.96
## 6         7.5   1.0     0.5       0.00            0                   0.3         9.30</code></pre>
<p>Discuss possible ‘features’ (columns) that we can extract from already existing columns. Recall that our goal is to tell interesting (unexpected, or not immediately obvious) stories based on the data, so think of features that would make this dataset more interesting to analyze and the story more compelling.</p>
</div>
<div id="date-and-time-features" class="section level2">
<h2><span class="header-section-number">4.1</span> Date and time features</h2>
<p>The first set of features we extract are date and time related features. Specifically, we would like to know the day of the week and the time of the day (based on our own cutoffs).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(dplyr)
<span class="kw">library</span>(lubridate)
weekday_labels &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&#39;Sun&#39;</span>, <span class="st">&#39;Mon&#39;</span>, <span class="st">&#39;Tue&#39;</span>, <span class="st">&#39;Wed&#39;</span>, <span class="st">&#39;Thu&#39;</span>, <span class="st">&#39;Fri&#39;</span>, <span class="st">&#39;Sat&#39;</span>)
cut_levels &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">5</span>, <span class="dv">9</span>, <span class="dv">12</span>, <span class="dv">16</span>, <span class="dv">18</span>, <span class="dv">22</span>) <span class="co"># used to bucket hour of day into</span>
hour_labels &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&#39;1AM-5AM&#39;</span>, <span class="st">&#39;5AM-9AM&#39;</span>, <span class="st">&#39;9AM-12PM&#39;</span>, <span class="st">&#39;12PM-4PM&#39;</span>, <span class="st">&#39;4PM-6PM&#39;</span>, <span class="st">&#39;6PM-10PM&#39;</span>, <span class="st">&#39;10PM-1AM&#39;</span>)
nyc_taxi &lt;-<span class="st"> </span><span class="kw">mutate</span>(nyc_taxi,
    <span class="dt">pickup_hour =</span> <span class="kw">addNA</span>(<span class="kw">cut</span>(<span class="kw">hour</span>(pickup_datetime), cut_levels)),
    <span class="dt">pickup_dow =</span> <span class="kw">factor</span>(<span class="kw">wday</span>(pickup_datetime), <span class="dt">levels =</span> <span class="dv">1</span>:<span class="dv">7</span>, <span class="dt">labels =</span> weekday_labels),
    <span class="dt">dropoff_hour =</span> <span class="kw">addNA</span>(<span class="kw">cut</span>(<span class="kw">hour</span>(dropoff_datetime), cut_levels)),
    <span class="dt">dropoff_dow =</span> <span class="kw">factor</span>(<span class="kw">wday</span>(dropoff_datetime), <span class="dt">levels =</span> <span class="dv">1</span>:<span class="dv">7</span>, <span class="dt">labels =</span> weekday_labels),
    <span class="dt">trip_duration =</span> <span class="kw">as.integer</span>(<span class="kw">as.duration</span>(dropoff_datetime -<span class="st"> </span>pickup_datetime))
    )
<span class="kw">levels</span>(nyc_taxi$pickup_hour) &lt;-<span class="st"> </span>hour_labels
<span class="kw">levels</span>(nyc_taxi$dropoff_hour) &lt;-<span class="st"> </span>hour_labels
<span class="kw">head</span>(nyc_taxi)</code></pre></div>
<pre><code>## # A tibble: 6 × 22
##       pickup_datetime    dropoff_datetime passenger_count trip_distance pickup_longitude
##                &lt;dttm&gt;              &lt;dttm&gt;           &lt;int&gt;         &lt;dbl&gt;            &lt;dbl&gt;
## 1 2016-06-21 21:33:52 2016-06-21 21:34:40               5          0.40              -74
## 2 2016-06-08 09:52:19 2016-06-08 10:19:55               1          5.20              -74
## 3 2016-06-14 23:27:22 2016-06-14 23:35:05               1          2.10              -74
## 4 2016-06-12 20:13:12 2016-06-12 20:18:53               5          2.23              -74
## 5 2016-06-10 23:40:21 2016-06-11 00:05:14               3          2.72              -74
## 6 2016-06-28 16:46:23 2016-06-28 16:54:57               1          1.30              -74
##   pickup_latitude rate_code_id dropoff_longitude dropoff_latitude payment_type
##             &lt;dbl&gt;       &lt;fctr&gt;             &lt;dbl&gt;            &lt;dbl&gt;       &lt;fctr&gt;
## 1            40.7     standard               -74             40.7         card
## 2            40.8     standard               -74             40.8         cash
## 3            40.7     standard               -74             40.7         card
## 4            40.8     standard               -74             40.8         card
## 5            40.7     standard               -74             40.7         card
## 6            40.7     standard               -74             40.7         cash
##   fare_amount extra mta_tax tip_amount tolls_amount improvement_surcharge total_amount
##         &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt;      &lt;dbl&gt;        &lt;dbl&gt;                 &lt;dbl&gt;        &lt;dbl&gt;
## 1         3.0   0.5     0.5       0.86            0                   0.3         5.16
## 2        21.5   0.0     0.5       0.00            0                   0.3        22.30
## 3         9.0   0.5     0.5       1.50            0                   0.3        11.80
## 4         8.0   0.5     0.5       2.79            0                   0.3        12.09
## 5        17.0   0.5     0.5       3.66            0                   0.3        21.96
## 6         7.5   1.0     0.5       0.00            0                   0.3         9.30
##   pickup_hour pickup_dow dropoff_hour dropoff_dow trip_duration
##        &lt;fctr&gt;     &lt;fctr&gt;       &lt;fctr&gt;      &lt;fctr&gt;         &lt;int&gt;
## 1    6PM-10PM        Tue     6PM-10PM         Tue            48
## 2     5AM-9AM        Wed     9AM-12PM         Wed          1656
## 3    10PM-1AM        Tue     10PM-1AM         Tue           463
## 4    6PM-10PM        Sun     6PM-10PM         Sun           341
## 5    10PM-1AM        Fri     10PM-1AM         Sat          1493
## 6    12PM-4PM        Tue     12PM-4PM         Tue           514</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">dp &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">x =</span> <span class="kw">seq</span>(.<span class="dv">01</span>, .<span class="dv">99</span>, <span class="dt">by =</span> .<span class="dv">01</span>))
dp$y &lt;-<span class="st"> </span><span class="kw">quantile</span>(nyc_taxi$trip_duration, <span class="dt">p =</span> dp$x, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)
<span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">y =</span> y/<span class="dv">60</span>, <span class="dt">x =</span> x*<span class="dv">100</span>), <span class="dt">data =</span> dp) +
<span class="st">  </span><span class="kw">geom_line</span>()</code></pre></div>
<p><img src="images/unnamed-chunk-106-1.png" width="960" /></p>
</div>
<div id="geographical-features" class="section level2">
<h2><span class="header-section-number">4.2</span> Geographical features</h2>
<p>The next set of features we extract from the data are geographical features, for which we load the following geospatial packages:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(rgeos)
<span class="kw">library</span>(sp)
<span class="kw">library</span>(maptools)</code></pre></div>
<p>It is common to store GIS data in R into <strong>shapefiles</strong>. A shapefile is essentially a data object that stores geospatial informaiton such as region names and boundaries where a region can be anything from a continent to city neighborhoods. The shapefile we use here was provided by Zillow.com and can be found <a href="http://www.zillow.com/howto/api/neighborhood-boundaries.htm">here</a>. It is a shapefile for the state of New York, and it contains neighborhood-level information for New York City.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">nyc_shapefile &lt;-<span class="st"> </span><span class="kw">readShapePoly</span>(<span class="st">&#39;ZillowNeighborhoods-NY/ZillowNeighborhoods-NY.shp&#39;</span>)</code></pre></div>
<p>We can see what sort of information is available by peeking at <code>nyc_shapefile@data</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">head</span>(nyc_shapefile@data, <span class="dv">10</span>)</code></pre></div>
<pre><code>##   STATE   COUNTY                        CITY            NAME REGIONID
## 0    NY   Monroe                   Rochester Ellwanger-Barry   343894
## 1    NY New York     New York City-Manhattan    West Village   270964
## 2    NY    Kings      New York City-Brooklyn     Bensonhurst   193285
## 3    NY     Erie                     Buffalo      South Park   270935
## 4    NY New York     New York City-Manhattan    East Village   270829
## 5    NY   Albany                      Albany      Park South   342684
## 6    NY Onondaga                    Syracuse     Meadowbrook   274481
## 7    NY   Queens        New York City-Queens      Auburndale   270797
## 8    NY Richmond New York City-Staten Island        Rosebank   197599
## 9    NY Onondaga                    Syracuse        Downtown   273487</code></pre>
<p>The data stores information about neighborhoods under the column <code>NAME</code>. Since we have longitude and latitude for pick-up and drop-off location, we can use the above data set to find the pick-up and drop-off neighborhoods for each cab ride. To keep the analysis simple, we limit the data to Manhattan only, where the great majority of cab rides take place.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">nyc_shapefile &lt;-<span class="st"> </span><span class="kw">subset</span>(nyc_shapefile, COUNTY ==<span class="st"> &#39;New York&#39;</span>) <span class="co"># limit the data to Manhattan only</span></code></pre></div>
<p>Notice that even though <code>nyc_shapefile</code> is not a <code>data.frame</code>, <code>subset</code> still worked. This is because subset is a function that works on more than just one kind of input. Quite a few R functions are the same way, such as <code>plot</code> and <code>predict</code>.</p>
<p>With a bit of work, we can plot a map of the whole area, showing the boundaries separating each neighborhood. We won’t go into great detail on how the plots are generated, as it would derail us from the main topic.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(ggplot2)
nyc_shapefile@data$id &lt;-<span class="st"> </span><span class="kw">as.character</span>(nyc_shapefile@data$NAME)
nyc_points &lt;-<span class="st"> </span><span class="kw">fortify</span>(<span class="kw">gBuffer</span>(nyc_shapefile, <span class="dt">byid =</span> <span class="ot">TRUE</span>, <span class="dt">width =</span> <span class="dv">0</span>), <span class="dt">region =</span> <span class="st">&quot;NAME&quot;</span>) <span class="co"># fortify neighborhood boundaries</span></code></pre></div>
<p>As part of the code to create the plot, we use <code>dplyr</code> to summarize the data and get median coordinates for each neighborhood, but since we revisit <code>dplyr</code> in greater depth in the next section, we skip the explanation for now.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(dplyr)
nyc_df &lt;-<span class="st"> </span><span class="kw">inner_join</span>(nyc_points, nyc_shapefile@data, <span class="dt">by =</span> <span class="st">&quot;id&quot;</span>)
nyc_centroids &lt;-<span class="st"> </span><span class="kw">summarize</span>(<span class="kw">group_by</span>(nyc_df, id), <span class="dt">long =</span> <span class="kw">median</span>(long), <span class="dt">lat =</span> <span class="kw">median</span>(lat))

<span class="kw">library</span>(ggrepel)
<span class="kw">library</span>(ggplot2)
<span class="kw">ggplot</span>(nyc_df) +
<span class="kw">aes</span>(long, lat, <span class="dt">fill =</span> id) +
<span class="kw">geom_polygon</span>() +
<span class="kw">geom_path</span>(<span class="dt">color =</span> <span class="st">&quot;white&quot;</span>) +
<span class="kw">coord_equal</span>() +
<span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">&quot;none&quot;</span>) +
<span class="kw">geom_text_repel</span>(<span class="kw">aes</span>(<span class="dt">label =</span> id), <span class="dt">data =</span> nyc_centroids, <span class="dt">size =</span> <span class="dv">3</span>)</code></pre></div>
<p><img src="images/unnamed-chunk-112-1.png" width="960" /></p>
<p>We now go back to the data to find the neighborhood information based on the pick-up and drop-off coordinates. We store pick-up longitude and latitude in a separate <code>data.frame</code>, replacing NAs with zeroes (the function we’re about to use doesn’t work with NAs). We then use the <code>coordinates</code> function to point to the columns that correspond to the geographical coordinates. Finally, we use the <code>over</code> function to find the region (in this case the neighborhood) that the coordinates in the data fall into, and we append the neighborhood name as a new column to the <code>nyc_taxi</code> dataset.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">data_coords &lt;-<span class="st"> </span><span class="kw">data.frame</span>(
    <span class="dt">long =</span> <span class="kw">ifelse</span>(<span class="kw">is.na</span>(nyc_taxi$pickup_longitude), <span class="dv">0</span>, nyc_taxi$pickup_longitude),
    <span class="dt">lat =</span> <span class="kw">ifelse</span>(<span class="kw">is.na</span>(nyc_taxi$pickup_latitude), <span class="dv">0</span>, nyc_taxi$pickup_latitude)
    )
<span class="kw">coordinates</span>(data_coords) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&#39;long&#39;</span>, <span class="st">&#39;lat&#39;</span>) <span class="co"># we specify the columns that correspond to the coordinates</span>
<span class="co"># we replace NAs with zeroes, becuase NAs won&#39;t work with the `over` function</span>
nhoods &lt;-<span class="st"> </span><span class="kw">over</span>(data_coords, nyc_shapefile) <span class="co"># returns the neighborhoods based on coordinates</span>
nyc_taxi$pickup_nhood &lt;-<span class="st"> </span>nhoods$NAME <span class="co"># we attach the neighborhoods to the original data and call it `pickup_nhood`</span></code></pre></div>
<p>We can use <code>table</code> to get a count of pick-up neighborhoods:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">head</span>(<span class="kw">table</span>(nyc_taxi$pickup_nhood, <span class="dt">useNA =</span> <span class="st">&quot;ifany&quot;</span>))</code></pre></div>
<pre><code>## 
##       19th Ward Abbott McKinley        Albright           Allen       Annandale 
##               0               0               0               0               0 
##      Arbor Hill 
##               0</code></pre>
<p>We now repeat the above process, this using drop-off coordinates this time to get the drop-off neighborhood.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">data_coords &lt;-<span class="st"> </span><span class="kw">data.frame</span>(
    <span class="dt">long =</span> <span class="kw">ifelse</span>(<span class="kw">is.na</span>(nyc_taxi$dropoff_longitude), <span class="dv">0</span>, nyc_taxi$dropoff_longitude),
    <span class="dt">lat =</span> <span class="kw">ifelse</span>(<span class="kw">is.na</span>(nyc_taxi$dropoff_latitude), <span class="dv">0</span>, nyc_taxi$dropoff_latitude)
    )
<span class="kw">coordinates</span>(data_coords) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&#39;long&#39;</span>, <span class="st">&#39;lat&#39;</span>)
nhoods &lt;-<span class="st"> </span><span class="kw">over</span>(data_coords, nyc_shapefile)
nyc_taxi$dropoff_nhood &lt;-<span class="st"> </span>nhoods$NAME</code></pre></div>
<p>And since <code>data_coords</code> and <code>nhoods</code> are potentially large objects, we remove them from our session when they’re no longer needed.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">rm</span>(data_coords, nhoods) <span class="co"># delete these objects, as they are no longer needed</span></code></pre></div>
<p>Note how we had to repeat the same process in two different steps, once to get pick-up and once to get drop-off neighborhoods. Now if we need to change something about the above code, we have to change it in two different places. For example, if we want to reset the factor levels so that only Manhattan neighborhoods are showing, we need to remember to do it twice.</p>
<p>Another downside is we ended up with leftover objects <code>data_coords</code> and <code>nhood</code>. Since both objects have the same number of rows as the <code>nyc_taxi</code> dataset, they are relatively large objects, so we manually deleted them from the R session using <code>rm</code> after we finished using them. Carrying around too many by-product objects in the R session that are no longer needed can result in us clogging the memory, especially if the objects take up a lot of space. So we need to be careful and do some housecleaning every now and then so our session remains clean. Doing so is easier said than done.</p>
<p>There is however something we can do to avoid both of the above headaches: wrap the process into an R function.</p>
<div id="exercises-6" class="section level3">
<h3><span class="header-section-number">4.2.1</span> Exercises</h3>
<ol style="list-style-type: decimal">
<li>Conceptually describe the function we described in the above section, in other words</li>
</ol>
<ul>
<li>what would be the input(s) to the function?</li>
<li>what would the function return as output?</li>
<li>what are the intermediate results that are created by the function?</li>
</ul>
<ol start="2" style="list-style-type: decimal">
<li>Here’s a basic user-defined R function:</li>
</ol>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">p &lt;-<span class="st"> </span><span class="dv">5</span>
do.something &lt;-<span class="st"> </span>function(n, d) {
    m &lt;-<span class="st"> </span>n +<span class="st"> </span>p
    <span class="kw">return</span>(m/d)
}</code></pre></div>
<ul>
<li>What is the name of the function?</li>
<li>What are the function’s arguments?</li>
<li>What are the local and global variables?</li>
<li>What is the “body” of the function?</li>
<li>What does the function return?</li>
<li>What happens to <code>m</code> and <code>d</code> (local variables) once the function finishes running?</li>
</ul>
<p>Try to predict what the function returns in the two cases here:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">do.something</span>(<span class="dv">10</span>, <span class="dv">3</span>)</code></pre></div>
<pre><code>## [1] 5</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">p &lt;-<span class="st"> </span><span class="dv">8</span>
<span class="kw">do.something</span>(<span class="dv">10</span>, <span class="dv">3</span>)</code></pre></div>
<pre><code>## [1] 6</code></pre>
<ol start="3" style="list-style-type: decimal">
<li>Change the above function so that <code>p</code> is always 5 for the function. There is more than one way to do this.</li>
</ol>
</div>
<div id="solutions-5" class="section level3">
<h3><span class="header-section-number">4.2.2</span> Solutions</h3>
<p>Here’s the solution to part (3). As we mentioned, there’s more than one way of doing this. One way is to turn <code>p</code> into an argument for the function <code>do.something</code>, with the default value set to 5.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">do.something &lt;-<span class="st"> </span>function(n, d, <span class="dt">p =</span> <span class="dv">5</span>) {
    m &lt;-<span class="st"> </span>n +<span class="st"> </span>p
    <span class="kw">return</span>(m/d)
}</code></pre></div>
<p>Another approach is to make <code>p</code> a local variable, instead of a global variable. When the function runs, regardless of what <code>p</code> is assigned to globally, <code>p</code> will always be assigned the value 5 in the function’s environment.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">do.something &lt;-<span class="st"> </span>function(n, d) {
    p &lt;-<span class="st"> </span><span class="dv">5</span>
    m &lt;-<span class="st"> </span>n +<span class="st"> </span>p
    <span class="kw">return</span>(m/d)
}

p &lt;-<span class="st"> </span><span class="dv">8</span>
<span class="kw">do.something</span>(<span class="dv">10</span>, <span class="dv">3</span>)</code></pre></div>
<pre><code>## [1] 5</code></pre>
</div>
</div>
<div id="creating-a-function" class="section level2">
<h2><span class="header-section-number">4.3</span> Creating a function</h2>
<p>With the last exercise as introduction, believe it or not, we know everything we need to know to accomplish the automation task we set out to do. We already have the bulk of the code that the function relies on, so it’s often a matter of pasting it into the body of the function and making some minor changes. To write good functions, we often begin by writing code that works, then we identify the need for automation (to reuse code, to automatically clean intermediate results), and finally we wrap the code around a function and modify and test it to make sure it still works.</p>
<p>Of course writing good functions can be more involved than what we described here. This is especially so when we write functions that we intend to use across multiple projects or share with others. In such cases, we often spend more time anticipating all the ways that the function could break given different inputs and try to account for such cases.</p>
<p>With the last exercise as a backdrop, let’s now delete <code>pickup_nhood</code> and <code>dropoff_nhood</code> from the data and recreate those columns, this time by writing a function.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">nyc_taxi$pickup_nhood &lt;-<span class="st"> </span><span class="ot">NULL</span> <span class="co"># we drop this column so we can re-create it here</span>
nyc_taxi$dropoff_nhood &lt;-<span class="st"> </span><span class="ot">NULL</span> <span class="co"># we drop this column so we can re-create it here</span></code></pre></div>
<div id="exercises-7" class="section level3">
<h3><span class="header-section-number">4.3.1</span> Exercises</h3>
<p>Here is our earlier code for appending neighborhood information (drop-off in this case) to the data using the shapefile. Wrap this code around a new function. Let’s call the function <code>add.neighborhoods</code>. Assign the function the correct inputs (think about what those need to be) and modify the code itself so the function takes those inputs and produces the correct output (think about what that needs to be). Once you have your function, run it twice, once to get pick-up neighborhood and once to get drop-off neighborhood.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">data_coords &lt;-<span class="st"> </span><span class="kw">data.frame</span>(
    <span class="dt">long =</span> <span class="kw">ifelse</span>(<span class="kw">is.na</span>(nyc_taxi$dropoff_longitude), <span class="dv">0</span>, nyc_taxi$dropoff_longitude),
    <span class="dt">lat =</span> <span class="kw">ifelse</span>(<span class="kw">is.na</span>(nyc_taxi$dropoff_latitude), <span class="dv">0</span>, nyc_taxi$dropoff_latitude)
    )
<span class="kw">coordinates</span>(data_coords) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&#39;long&#39;</span>, <span class="st">&#39;lat&#39;</span>)
nhoods &lt;-<span class="st"> </span><span class="kw">over</span>(data_coords, nyc_shapefile)
nyc_taxi$dropoff_nhood &lt;-<span class="st"> </span>nhoods$NAME</code></pre></div>
</div>
<div id="solution" class="section level3">
<h3><span class="header-section-number">4.3.2</span> Solution</h3>
<p>We call the function <code>add.neighborhoods</code>. Its inputs are the dataset, the names of the longitude and latitude coordinates (as strings), and the shapefile. The output we return is a single column containing the neighborhoods names.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">add.neighborhoods &lt;-<span class="st"> </span>function(long_var, lat_var, shapefile) {
    <span class="kw">require</span>(rgeos)
    <span class="kw">require</span>(maptools)
    data_coords &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">long =</span> <span class="kw">ifelse</span>(<span class="kw">is.na</span>(long_var), <span class="dv">0</span>, long_var),
        <span class="dt">lat =</span> <span class="kw">ifelse</span>(<span class="kw">is.na</span>(lat_var), <span class="dv">0</span>, lat_var)) <span class="co"># create `data.frame` with only those two columns</span>
    <span class="kw">coordinates</span>(data_coords) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&#39;long&#39;</span>, <span class="st">&#39;lat&#39;</span>) <span class="co"># designate the columns as geographica l coordinates</span>
    nhoods &lt;-<span class="st"> </span><span class="kw">over</span>(data_coords, shapefile) <span class="co"># find the neighborhoods the coordinates fall into</span>
    nhoods$NAME &lt;-<span class="st"> </span><span class="kw">factor</span>(nhoods$NAME, <span class="dt">levels =</span> <span class="kw">as.character</span>(shapefile@data$NAME)) <span class="co"># reset factor levels to Manhattan only</span>
    <span class="kw">return</span>(nhoods$NAME) <span class="co"># return only the column with the neighborhoods</span>
}</code></pre></div>
<p>We can now use our function twice. Once to find the pick-up neighborhood:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">nyc_taxi$pickup_nhood &lt;-<span class="st"> </span><span class="kw">add.neighborhoods</span>(nyc_taxi$pickup_longitude, nyc_taxi$pickup_latitude, nyc_shapefile)
<span class="kw">table</span>(nyc_taxi$pickup_nhood, <span class="dt">useNA =</span> <span class="st">&quot;ifany&quot;</span>)</code></pre></div>
<pre><code>## 
##        West Village        East Village        Battery Park       Carnegie Hill 
##              140332              204170               55599               69672 
##            Gramercy                Soho         Murray Hill        Little Italy 
##              466436              119095              200315               50010 
##        Central Park   Greenwich Village             Midtown Morningside Heights 
##               80785              270512              972293               28971 
##              Harlem    Hamilton Heights             Tribeca   North Sutton Area 
##               30857               11817               97612               59162 
##     Upper East Side  Financial District              Inwood             Chelsea 
##              815312              126715                 619              397915 
##     Lower East Side           Chinatown  Washington Heights     Upper West Side 
##              139292               18155                7712              494749 
##             Clinton           Yorkville    Garment District         East Harlem 
##              177426               39669              349100               18737 
##                &lt;NA&gt; 
##              556961</code></pre>
<p>And a second time to find the drop-off neighborhood:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">nyc_taxi$dropoff_nhood &lt;-<span class="st"> </span><span class="kw">add.neighborhoods</span>(nyc_taxi$dropoff_longitude, nyc_taxi$dropoff_latitude, nyc_shapefile)
<span class="kw">table</span>(nyc_taxi$dropoff_nhood, <span class="dt">useNA =</span> <span class="st">&quot;ifany&quot;</span>)</code></pre></div>
<pre><code>## 
##        West Village        East Village        Battery Park       Carnegie Hill 
##              126134              181670               57527               77552 
##            Gramercy                Soho         Murray Hill        Little Italy 
##              428740              113317              198077               36578 
##        Central Park   Greenwich Village             Midtown Morningside Heights 
##               71733              218430              914279               45488 
##              Harlem    Hamilton Heights             Tribeca   North Sutton Area 
##               70489               24468               90444               47733 
##     Upper East Side  Financial District              Inwood             Chelsea 
##              772333              132628                5436              358347 
##     Lower East Side           Chinatown  Washington Heights     Upper West Side 
##              119798               17240               35333              489991 
##             Clinton           Yorkville    Garment District         East Harlem 
##              188263               66955              288773               38368 
##                &lt;NA&gt; 
##              783876</code></pre>
</div>
<div id="exercises-8" class="section level3">
<h3><span class="header-section-number">4.3.3</span> Exercises</h3>
<p>Let’s revisit the function we defined in the last exercise:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">p &lt;-<span class="st"> </span><span class="dv">5</span>
do.something &lt;-<span class="st"> </span>function(n, d) {
    m &lt;-<span class="st"> </span>n +<span class="st"> </span>p
    m/d
}</code></pre></div>
<ol style="list-style-type: decimal">
<li><p>Is the function <strong>“vectorized”</strong>? i.e. if the input(s) is a vector are the outputs also vectors? Show by example. This question is not trivial, because vectorized functions can be used directly for column transformations (after all, columns in a <code>data.frame</code> are just vectors).</p></li>
<li><p>Based on what we learned about vectorized functions, is the <code>ifelse</code> function vectorized? what about <code>if</code> and <code>else</code>? Once again answer the question using examples for each.</p></li>
</ol>
</div>
<div id="solutions-6" class="section level3">
<h3><span class="header-section-number">4.3.4</span> Solutions</h3>
<p>For part (1) instead of feeding single numbers as inputs to the function, we try an <code>integer</code> vector instead. Since the function has two inputs, we can try an <code>integer</code> vector as the first input (and singleton as the second), vice versa, or <code>integer</code> vectors for both inputs.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">do.something</span>(<span class="dv">10</span>, <span class="dv">3</span>) <span class="co"># singleton inputs</span></code></pre></div>
<pre><code>## [1] 5</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">do.something</span>(<span class="dv">1</span>:<span class="dv">10</span>, <span class="dv">3</span>) <span class="co"># first input is a vector, output is also a vector</span></code></pre></div>
<pre><code>##  [1] 2.00 2.33 2.67 3.00 3.33 3.67 4.00 4.33 4.67 5.00</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">do.something</span>(<span class="dv">1</span>:<span class="dv">10</span>, <span class="kw">seq</span>(<span class="dv">1</span>, <span class="dv">20</span>, <span class="dt">by =</span> <span class="dv">2</span>)) <span class="co"># both inputs are vectors, as is the output</span></code></pre></div>
<pre><code>##  [1] 6.000 2.333 1.600 1.286 1.111 1.000 0.923 0.867 0.824 0.789</code></pre>
<p>For part (2), here’s how we can show that <code>ifelse</code> is vectorized:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ifelse</span>(<span class="dv">2</span> &gt;<span class="st"> </span><span class="dv">1</span>, <span class="dv">55</span>, <span class="dv">0</span>) <span class="co"># singleton condition and output</span></code></pre></div>
<pre><code>## [1] 55</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ifelse</span>(<span class="dv">0</span>:<span class="dv">5</span> &gt;<span class="st"> </span><span class="dv">1</span>, <span class="dv">55</span>, <span class="dv">0</span>) <span class="co"># condition is vector, so is the output</span></code></pre></div>
<pre><code>## [1]  0  0 55 55 55 55</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ifelse</span>(<span class="dv">0</span>:<span class="dv">5</span> &gt;<span class="st"> </span><span class="dv">1</span>, letters[<span class="dv">1</span>:<span class="dv">6</span>], LETTERS[<span class="dv">1</span>:<span class="dv">6</span>]) <span class="co"># all inputs are vectors, so is the output</span></code></pre></div>
<pre><code>## [1] &quot;A&quot; &quot;B&quot; &quot;c&quot; &quot;d&quot; &quot;e&quot; &quot;f&quot;</code></pre>
<p>However, <code>if</code> and <code>else</code> are not vectorized functions, as can be seen by the following example:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">if(<span class="dv">2</span> &gt;<span class="st"> </span><span class="dv">1</span>) <span class="dv">55</span> else <span class="dv">0</span> <span class="co"># singleton condition works fine</span></code></pre></div>
<pre><code>## [1] 55</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">if(<span class="dv">0</span>:<span class="dv">5</span> &gt;<span class="st"> </span><span class="dv">1</span>) <span class="dv">55</span> else <span class="dv">0</span> <span class="co"># vector of conditions does not work (only the first element) is considered</span></code></pre></div>
<pre><code>## [1] 0</code></pre>
<p>This means that we generally use <code>ifelse</code> when we need to transform the data (e.g. create a new column) based on conditional statements, whereas we use <code>if</code> and <code>else</code> when we need to check a single condition, such as this:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">if(<span class="kw">length</span>(<span class="kw">dir</span>(data_dir)) &lt;<span class="st"> </span><span class="dv">1</span>) {
  <span class="kw">warning</span>(<span class="kw">sprintf</span>(<span class="st">&quot;%s folder seems empty!&quot;</span>, data_dir))
} else {
  <span class="kw">dir</span>(data_dir)
}</code></pre></div>
<pre><code>## [1] &quot;NYC_sample.csv&quot;                &quot;yellow_tripsample_2016-01.csv&quot;
## [3] &quot;yellow_tripsample_2016-02.csv&quot; &quot;yellow_tripsample_2016-03.csv&quot;
## [5] &quot;yellow_tripsample_2016-04.csv&quot; &quot;yellow_tripsample_2016-05.csv&quot;
## [7] &quot;yellow_tripsample_2016-06.csv&quot;</code></pre>
</div>
</div>
<div id="tipping-behavior" class="section level2">
<h2><span class="header-section-number">4.4</span> Tipping behavior</h2>
<p>We now calculate the tipping percentage for every trip.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">nyc_taxi &lt;-<span class="st"> </span><span class="kw">mutate</span>(nyc_taxi, <span class="dt">tip_percent =</span> <span class="kw">as.integer</span>(tip_amount /<span class="st"> </span>(tip_amount +<span class="st"> </span>fare_amount) *<span class="st"> </span><span class="dv">100</span>))</code></pre></div>
<p>The percentage for people who tipped nothing is a bit suspicious. The above table is useful, but it might be easier for us to see the distribution if we plot the histogram. And since there’s a good chance that method of payment affects tipping, we break up the histogram by <code>payment_type</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">dp &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">x =</span> <span class="kw">seq</span>(.<span class="dv">01</span>, .<span class="dv">99</span>, <span class="dt">by =</span> .<span class="dv">01</span>))
dp$y &lt;-<span class="st"> </span><span class="kw">quantile</span>(nyc_taxi$tip_percent, <span class="dt">p =</span> dp$x, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)
<span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">y =</span> y, <span class="dt">x =</span> x*<span class="dv">100</span>), <span class="dt">data =</span> dp) +
<span class="st">  </span><span class="kw">geom_line</span>()</code></pre></div>
<p><img src="images/unnamed-chunk-137-1.png" width="960" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(ggplot2)
<span class="kw">ggplot</span>(<span class="dt">data =</span> nyc_taxi) +
<span class="kw">geom_histogram</span>(<span class="kw">aes</span>(<span class="dt">x =</span> tip_percent), <span class="dt">binwidth =</span> <span class="dv">1</span>) +<span class="st"> </span><span class="co"># show a separate bar for each percentage</span>
<span class="kw">facet_grid</span>(payment_type ~<span class="st"> </span>., <span class="dt">scales =</span> <span class="st">&quot;free&quot;</span>) +<span class="st"> </span><span class="co"># break up by payment type and allow different scales for &#39;y-axis&#39;</span>
<span class="kw">xlim</span>(<span class="kw">c</span>(-<span class="dv">1</span>, <span class="dv">31</span>)) <span class="co"># only show tipping percentages between 0 and 30</span></code></pre></div>
<p><img src="images/unnamed-chunk-138-1.png" width="960" /></p>
<p>The histogram confirms what we suspected: tipping is affected by the method of payment. However, it is unlikely to believe that people who pay cash simply don’t tip. A more believable scenario is that cash customers tip too, but their tip does not get recorded into the system as tip. In the next exercise, we try our hand at simulating tipping behavior for cash customers.</p>
<p>Instead of ignoring tip amount for customers who pay cash, or pretending that it’s really zero, in the last exercise we wrote a function that uses a simple rule-based approach to find how much to tipping. In the next exercise, we apply the function to the dataset. But before we do that, let’s use an alternative approach to the rule-based method: Let’s use a statistical technique to estimate tipping behavior, here’s one naive way of doing it:</p>
<p>Since even among card-paying customers, a small proportion don’t tip, we can toss a coin and do as follows:</p>
<ul>
<li>With 5 percent probability the customer does not tip</li>
<li>With 95 percent probability the customer tips, and the tip is a certain percentage of the fare amount and a random component. More specifically, the tip is determined by drawing from a normal distribution centered around 20 percent of the fare amount with a standard deviation of 25 cents.</li>
</ul>
<p>Here’s how we can apply the above logic to the dataste:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">nyc_taxi &lt;-<span class="st"> </span><span class="kw">mutate</span>(nyc_taxi,
    <span class="dt">toss_coin =</span> <span class="kw">rbinom</span>(<span class="kw">nrow</span>(nyc_taxi), <span class="dv">1</span>, <span class="dt">p =</span> .<span class="dv">95</span>), <span class="co"># toss a coin</span>
    <span class="dt">tip_if_heads =</span> <span class="kw">rnorm</span>(<span class="kw">nrow</span>(nyc_taxi), <span class="dt">mean =</span> fare_amount *<span class="st"> </span><span class="fl">0.20</span>, <span class="dt">sd =</span> .<span class="dv">25</span>),
    <span class="dt">tip_if_tails =</span> <span class="dv">0</span>, <span class="co"># if tails don&#39;t tip</span>
    <span class="dt">tip_amount =</span>
    <span class="kw">ifelse</span>(payment_type ==<span class="st"> &#39;cash&#39;</span>,
        <span class="kw">ifelse</span>(toss_coin, tip_if_heads, tip_if_tails), <span class="co"># when payment method is cash apply the above rule</span>
        <span class="kw">ifelse</span>(payment_type ==<span class="st"> &#39;card&#39;</span>, tip_amount, <span class="ot">NA</span>)), <span class="co"># otherwise just use the data we have</span>
    <span class="dt">tip_percent =</span> <span class="kw">as.integer</span>(tip_amount /<span class="st"> </span>(tip_amount +<span class="st"> </span>fare_amount) *<span class="st"> </span><span class="dv">100</span>), <span class="co"># recalculate tip percentage</span>
    <span class="dt">toss_coin =</span> <span class="ot">NULL</span>, <span class="co"># drop variables we no longer need</span>
    <span class="dt">tip_if_heads =</span> <span class="ot">NULL</span>,
    <span class="dt">tip_if_tails =</span> <span class="ot">NULL</span>
)</code></pre></div>
<p>Let’s visualize the percentage tipped to for card and cash customers now.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(ggplot2)
<span class="kw">ggplot</span>(<span class="dt">data =</span> nyc_taxi) +
<span class="st">  </span><span class="kw">geom_histogram</span>(<span class="kw">aes</span>(<span class="dt">x =</span> tip_percent), <span class="dt">binwidth =</span> <span class="dv">1</span>) +<span class="st"> </span><span class="co"># show a separate bar for each percentage</span>
<span class="st">  </span><span class="kw">facet_grid</span>(payment_type ~<span class="st"> </span>., <span class="dt">scales =</span> <span class="st">&quot;free&quot;</span>) +<span class="st"> </span><span class="co"># break up by payment type and allow different scales for &#39;y-axis&#39;</span>
<span class="st">  </span><span class="kw">xlim</span>(<span class="kw">c</span>(-<span class="dv">1</span>, <span class="dv">31</span>)) <span class="co"># only show tipping percentages between 0 and 30</span></code></pre></div>
<p><img src="images/unnamed-chunk-140-1.png" width="960" /></p>
<div id="exercises-9" class="section level3">
<h3><span class="header-section-number">4.4.1</span> Exercises</h3>
<p>When processing a <code>data.frame</code> with R, <strong>vectorized functions</strong> show up in many places. Without them, our R code would be more verbose, and often (though not always) less efficient. Let’s look at another example of this by looking at the relationship between tipping and method of payment. Let’s assume that most cash customers tip (but the amount they tip does not show in the data). We further assume that tipping behavior for cash vs card customers is very different in the following way:</p>
<ul>
<li>card customers might tip based on a certain percentage (automatically calculated when they swipe)</li>
<li>cash customers might tip by rounding up (and thereby avoid getting small change)</li>
</ul>
<p>For example, a card customer could tip 10 percent regardless of the fare amount, but a cash customer whose fare is $4.65 would round up to $6, and if the fare is $26.32 they would round up to $30. So the cash customer’s tip is also proportional to the fare amount, but partly driven by the need to avoid getting change or doing the math. We want to find a way to simulate this behavior.</p>
<p>In other words, we want to write a function that calculates tip by <em>rounding up</em> the fare amount. Writing such a function from scratch is a little tedious. Fortunately, there is already a function in <code>base</code> R to help us:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">findInterval</span>(<span class="fl">3.66</span>, <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">3</span>, <span class="fl">4.5</span>, <span class="dv">6</span>, <span class="dv">10</span>))</code></pre></div>
<pre><code>## [1] 2</code></pre>
<p>Take a moment to inspect and familiarize yourself with the above function:</p>
<ul>
<li>What does the above function return?</li>
<li>What are some ways the function could “misbehave”? In other words, check what the function returns when odd inputs are provided, including NAs.</li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">findInterval</span>(<span class="ot">NA</span>, <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">3</span>, <span class="fl">4.5</span>, <span class="dv">6</span>, <span class="dv">10</span>))</code></pre></div>
<pre><code>## [1] NA</code></pre>
<p>Let’s break up the above code into two parts:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">upper_limits &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">3</span>, <span class="fl">4.5</span>, <span class="dv">6</span>, <span class="dv">10</span>)
<span class="kw">findInterval</span>(<span class="fl">3.66</span>, upper_limits)</code></pre></div>
<pre><code>## [1] 2</code></pre>
<ol style="list-style-type: decimal">
<li><p>Modify the last line so that we return the first number higher than the number we provide. In this case: the number we provide is 3.66, the first number higher than 3.66 is 4.5, so modify the code to return 4.5 only. (HINT: think of the line as the index to another vector.)</p></li>
<li><p>Is the function <code>findInterval</code> vectorized? show by example.</p></li>
<li><p>Wrap the above solution into a function called <code>round_up_fare</code> and test it with the following input:</p></li>
</ol>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">sample_of_fares &lt;-<span class="st"> </span><span class="kw">c</span>(.<span class="dv">55</span>, <span class="fl">2.33</span>, <span class="dv">4</span>, <span class="fl">6.99</span>, <span class="fl">15.20</span>, <span class="dv">18</span>, <span class="dv">23</span>, <span class="dv">44</span>)
<span class="kw">round_up_fare</span>(sample_of_fares, upper_limits)</code></pre></div>
<p>Here’s the result we expect to get:</p>
<ol start="4" style="list-style-type: decimal">
<li>Replace the statistical approach to simulating <code>tip_amount</code> for the cash customers with the rule-based approach implemented in the above function. In the data transformation above (under <code>nyc_taxi &lt;- mutate(...)</code>), replace the line <code>tip_if_heads = rnorm(...)</code> with the transformation corresponding to the rule-based approach, as implemented by <code>round_up_fare</code>. Use the following fare round-up upper limits:</li>
</ol>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">fare_intervals &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">0</span>:<span class="dv">10</span>, <span class="kw">seq</span>(<span class="dv">12</span>, <span class="dv">20</span>, <span class="dt">by =</span> <span class="dv">2</span>), <span class="kw">seq</span>(<span class="dv">25</span>, <span class="dv">50</span>, <span class="dt">by =</span> <span class="dv">5</span>), <span class="kw">seq</span>(<span class="dv">55</span>, <span class="dv">100</span>, <span class="dt">by =</span> <span class="dv">10</span>))
<span class="kw">round_up_fare</span>(<span class="dv">23</span>, fare_intervals)</code></pre></div>
<p>Run the new transformation and recreate the plot, comment on the new distribution.</p>
</div>
<div id="solutions-7" class="section level3">
<h3><span class="header-section-number">4.4.2</span> Solutions</h3>
<ol style="list-style-type: decimal">
<li>We want to return one of the elements of <code>upper_limits</code>. Which element we return is dynamically determined by <code>findIntarval</code>, except we need to add 1 to return the upper limit (otherwise the lower limit is returned).</li>
</ol>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">upper_limits[<span class="kw">findInterval</span>(<span class="dv">0</span>, upper_limits) +<span class="st"> </span><span class="dv">1</span>]</code></pre></div>
<pre><code>## [1] 1</code></pre>
<ol start="2" style="list-style-type: decimal">
<li>The problem reduces to finding out if <code>findInterval</code> is vectorized. We simply feed a vector, <code>1:5</code> in this example, to <code>findInterval</code> and make sure that it returns a vector.</li>
</ol>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">upper_limits[<span class="kw">findInterval</span>(<span class="dv">1</span>:<span class="dv">5</span>, upper_limits) +<span class="st"> </span><span class="dv">1</span>]</code></pre></div>
<pre><code>## [1] 3.0 3.0 4.5 4.5 6.0</code></pre>
<ol start="3" style="list-style-type: decimal">
<li>Once we have the logic figured out, wrapping it into a neat function is usually the easy part. Here the function will default to using <code>upper_limit</code> unless otherwise specified.</li>
</ol>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">round_up_fare &lt;-<span class="st"> </span>function(x, <span class="dt">ul =</span> upper_limits) {
    upper_limits[<span class="kw">findInterval</span>(x, upper_limits) +<span class="st"> </span><span class="dv">1</span>]
}

sample_of_fares &lt;-<span class="st"> </span><span class="kw">c</span>(.<span class="dv">55</span>, <span class="fl">2.33</span>, <span class="dv">4</span>, <span class="fl">6.99</span>, <span class="fl">15.20</span>, <span class="dv">18</span>, <span class="dv">23</span>, <span class="dv">44</span>)
<span class="kw">round_up_fare</span>(sample_of_fares)</code></pre></div>
<pre><code>## [1]  1.0  3.0  4.5 10.0   NA   NA   NA   NA</code></pre>
<ol start="4" style="list-style-type: decimal">
<li>Just replace <code>tip_if_heads = rnorm(nrow(nyc_taxi), mean = fare_amount * 0.20, sd = .25)</code> with <code>tip_if_heads = round_up_fare(fare_amount, fare_intervals) - fare_amount</code> and rerun the whole code chunk and the one after it for recreating the plot.</li>
</ol>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">nyc_taxi &lt;-<span class="st"> </span><span class="kw">mutate</span>(nyc_taxi,
    <span class="dt">toss_coin =</span> <span class="kw">rbinom</span>(<span class="kw">nrow</span>(nyc_taxi), <span class="dv">1</span>, <span class="dt">p =</span> .<span class="dv">95</span>), <span class="co"># toss a coin</span>
    <span class="dt">tip_if_heads =</span> <span class="kw">round_up_fare</span>(fare_amount, fare_intervals) -<span class="st"> </span>fare_amount,
    <span class="dt">tip_if_tails =</span> <span class="dv">0</span>, <span class="co"># if tails don&#39;t tip</span>
    <span class="dt">tip_amount =</span>
    <span class="kw">ifelse</span>(payment_type ==<span class="st"> &#39;cash&#39;</span>,
        <span class="kw">ifelse</span>(toss_coin, tip_if_heads, tip_if_tails), <span class="co"># when payment method is cash apply the above rule</span>
        <span class="kw">ifelse</span>(payment_type ==<span class="st"> &#39;card&#39;</span>, tip_amount, <span class="ot">NA</span>)), <span class="co"># otherwise just use the data we have</span>
    <span class="dt">tip_percent =</span> <span class="kw">as.integer</span>(tip_amount /<span class="st"> </span>(tip_amount +<span class="st"> </span>fare_amount) *<span class="st"> </span><span class="dv">100</span>), <span class="co"># recalculate tip percentage</span>
    <span class="dt">toss_coin =</span> <span class="ot">NULL</span>, <span class="co"># drop variables we no longer need</span>
    <span class="dt">tip_if_heads =</span> <span class="ot">NULL</span>,
    <span class="dt">tip_if_tails =</span> <span class="ot">NULL</span>)

<span class="kw">library</span>(ggplot2)
<span class="kw">ggplot</span>(<span class="dt">data =</span> nyc_taxi) +
<span class="kw">geom_histogram</span>(<span class="kw">aes</span>(<span class="dt">x =</span> tip_percent), <span class="dt">binwidth =</span> <span class="dv">1</span>) +<span class="st"> </span><span class="co"># show a separate bar for each percentage</span>
<span class="kw">facet_grid</span>(payment_type ~<span class="st"> </span>., <span class="dt">scales =</span> <span class="st">&quot;free&quot;</span>) +<span class="st"> </span><span class="co"># break up by payment type and allow different scales for &#39;y-axis&#39;</span>
<span class="kw">xlim</span>(<span class="kw">c</span>(-<span class="dv">1</span>, <span class="dv">31</span>)) <span class="co"># only show tipping percentages between 0 and 30</span></code></pre></div>
<p><img src="images/unnamed-chunk-149-1.png" width="960" /></p>
<p>It shouldn’t be surprising that the rounding behavior results in a histogram with certain gaps between the bars, especially between the numbers 10 and 20.</p>

</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="cleaning-the-data.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="data-summary-and-analysis.html" class="navigation navigation-next " aria-label="Next page""><i class="fa fa-angle-right"></i></a>

<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"google": false,
"weibo": false,
"instapper": false,
"vk": false,
"all": ["facebook", "google", "twitter", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
